<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Hiyasame</title>
  
  <subtitle>å±±èŒ¶é›¾å±¿</subtitle>
  <link href="http://blog.coldrain.ink/atom.xml" rel="self"/>
  
  <link href="http://blog.coldrain.ink/"/>
  <updated>2024-05-14T17:16:51.000Z</updated>
  <id>http://blog.coldrain.ink/</id>
  
  <author>
    <name>å¯’é›¨</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>å®ç°ä¸€ä¸ª crepl</title>
    <link href="http://blog.coldrain.ink/2024/05/14/KEXzdAOJSo1UjlxaR0bcc6m5njT/"/>
    <id>http://blog.coldrain.ink/2024/05/14/KEXzdAOJSo1UjlxaR0bcc6m5njT/</id>
    <published>2024-05-14T17:01:24.000Z</published>
    <updated>2024-05-14T17:16:51.000Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://jyywiki.cn/OS/2024/labs/M4.md">https://jyywiki.cn/OS/2024/labs/M4.md</a></p><p>ä»Šå¹´åœ¨è¿½ç•ªè’‹ç‚å²©è€å¸ˆçš„ NJU OS 2024springã€‚å› ä¸ºä¹‹å‰å·²ç»åšè¿‡ä¸å°‘ os labï¼Œæ‰€ä»¥è¿™æ¬¡ä¸æ‰“ç®—åš os labï¼Œä½†æ˜¯å‘ç° jyy çš„é OS lab è®¾è®¡å¾—éƒ½éå¸¸æœ‰æ„æ€ï¼Œæ‰€ä»¥å†³å®šåšä¸€ä¸‹ã€‚</p><p>ä»¥å‰æˆ‘ä»æ¥æ²¡æœ‰æ€è€ƒè¿‡ crepl è¦æ€ä¹ˆå®ç°ï¼Œæ²¡æƒ³åˆ°åˆ©ç”¨ gcc å°±å¯ä»¥å¦‚æ­¤å®¹æ˜“çš„å®ç°ä¸€ä¸ª creplï¼Œä»¥å‰æ²¡æ€ä¹ˆæ¥è§¦è¿‡çš„ so åº“çš„ç”¨æ³•å’Œå…¶æœ¬è´¨ä¹Ÿé€æ¸ç†Ÿæ‚‰èµ·æ¥äº†ã€‚</p><p>è™½è¯´å‡ºäºå­¦æœ¯è¯šä¿¡ä¸Šçš„è€ƒé‡ jyy å¹¶ä¸å¸Œæœ›æˆ‘ä»¬å…¬å¼€ lab ä»£ç ï¼Œä½†æ˜¯è¿™ä¸ª lab ç¡®å®æ²¡ä»€ä¹ˆéš¾çš„åœ°æ–¹ï¼Œç›¸ä¿¡ä¸ä¼šæœ‰å—å¤§å­¦å­ä¸Šç½‘æœä»£ç æŠ„çš„ã€‚å¹¶ä¸”æˆ‘å› ä¸ºå·æ‡’ç›´æ¥ä½¿ç”¨äº† <code>system</code> ï¼Œç›´æ¥æŠ„æˆ‘çš„ä¹Ÿå¾—è€è€å®å®æ”¹æˆ <code>fork</code> &amp; <code>execve</code> å®ç°:D</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> wrapper_count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">char</span> line[<span class="number">4096</span>];</span><br><span class="line">    <span class="type">char</span> cmd[<span class="number">4096</span>];</span><br><span class="line">    <span class="type">char</span> temp_so_path[] = <span class="string">&quot;/tmp/crepl_so.XXXXXX&quot;</span>;</span><br><span class="line">    <span class="type">char</span> temp_src_path[] = <span class="string">&quot;/tmp/crepl_src.XXXXXX&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ†é…ä¸´æ—¶æ–‡ä»¶</span></span><br><span class="line">    <span class="type">int</span> fd = mkstemp(temp_so_path);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;mkstemp failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">    fd = mkstemp(temp_src_path);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;mkstemp failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// -Wno-implicit-function-declaration   </span></span><br><span class="line">    <span class="comment">// ç”¨äºç»•è¿‡åœ¨è°ƒç”¨å…¶ä»–å‡½æ•°åœºæ™¯ä¸‹çš„éšå¼å‡½æ•°å®šä¹‰çš„æ£€æŸ¥</span></span><br><span class="line">    <span class="built_in">sprintf</span>(cmd,</span><br><span class="line">            <span class="string">&quot;gcc -Wno-implicit-function-declaration -xc &quot;</span></span><br><span class="line">            <span class="string">&quot;-shared -o %s %s&quot;</span>,</span><br><span class="line">            temp_so_path, temp_src_path);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;crepl&gt; &quot;</span>);</span><br><span class="line">        fflush(<span class="built_in">stdout</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!fgets(line, <span class="keyword">sizeof</span>(line), <span class="built_in">stdin</span>)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// To be implemented.</span></span><br><span class="line">        <span class="comment">// printf(&quot;Got %zu chars.\n&quot;, strlen(line));</span></span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> is_function = <span class="built_in">strncmp</span>(line, <span class="string">&quot;int &quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;int &quot;</span>)) == <span class="number">0</span>;</span><br><span class="line">        <span class="type">char</span> func_name[<span class="number">256</span>];</span><br><span class="line">        <span class="type">char</span> func[<span class="number">4096</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_function) &#123;</span><br><span class="line">            <span class="built_in">strcpy</span>(func, line);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">sprintf</span>(func_name, <span class="string">&quot;__expr_wrapper_%d&quot;</span>, wrapper_count++);</span><br><span class="line">            <span class="built_in">sprintf</span>(func, <span class="string">&quot;int %s() &#123; return %s; &#125;&quot;</span>, func_name, line);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°†å‡½æ•°å†™å…¥ä¸´æ—¶æ–‡ä»¶</span></span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯è¡¨è¾¾å¼ï¼Œå°±ç¼–è¯‘æˆ so ç„¶å dlopen æ‰§è¡Œ expr wrapper</span></span><br><span class="line">        FILE* file = fopen(temp_src_path, <span class="string">&quot;a&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (file == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;Failed to open file&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">fprintf</span>(file, <span class="string">&quot;%s\n&quot;</span>, func);</span><br><span class="line">        fflush(file);</span><br><span class="line">        fclose(file);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åªæ˜¯æ·»åŠ å‡½æ•°å®šä¹‰çš„è¯ä¸éœ€è¦ç¼–è¯‘</span></span><br><span class="line">        <span class="keyword">if</span> (is_function) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;OK.\n&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç¼–è¯‘æˆ so</span></span><br><span class="line">        system(cmd);</span><br><span class="line"></span><br><span class="line">        <span class="type">void</span> *handle;</span><br><span class="line">        <span class="type">int</span> (*function)(<span class="type">void</span>);</span><br><span class="line">        <span class="type">char</span> *error;</span><br><span class="line">        <span class="type">int</span> eval_result;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åŠ è½½å…±äº«åº“</span></span><br><span class="line">        handle = dlopen(temp_so_path, RTLD_LAZY);</span><br><span class="line">        <span class="keyword">if</span> (!handle) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;%s\n&quot;</span>, dlerror());</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¸…é™¤ç°æœ‰çš„é”™è¯¯</span></span><br><span class="line">        dlerror();</span><br><span class="line">        </span><br><span class="line">        *(<span class="type">void</span> **) (&amp;function) = dlsym(handle, func_name);</span><br><span class="line">        <span class="keyword">if</span> ((error = dlerror()) != <span class="literal">NULL</span>)  &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;%s\n&quot;</span>, error);</span><br><span class="line">            dlclose(handle);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è°ƒç”¨å‡½æ•°</span></span><br><span class="line">        eval_result = function();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å…³é—­å…±äº«åº“</span></span><br><span class="line">        dlclose(handle);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;= %d.\n&quot;</span>, eval_result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://jyywiki.cn/OS/2024/labs/M4.md&quot;&gt;https://jyywiki.cn/OS/2024/labs/M4.md&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ä»Šå¹´åœ¨è¿½ç•ªè’‹ç‚å²©è€å¸ˆçš„ NJU OS 2024springã€‚å› ä¸ºä¹‹å‰å·²ç»åšè¿‡ä¸å°‘</summary>
      
    
    
    
    
    <category term="jyy" scheme="http://blog.coldrain.ink/tags/jyy/"/>
    
    <category term="os" scheme="http://blog.coldrain.ink/tags/os/"/>
    
    <category term="lab" scheme="http://blog.coldrain.ink/tags/lab/"/>
    
  </entry>
  
  <entry>
    <title>Linux å¹¶å‘åŸè¯­å®ç°</title>
    <link href="http://blog.coldrain.ink/2024/03/03/QJR7dadPhoMef5xUVacc8mVqnGg/"/>
    <id>http://blog.coldrain.ink/2024/03/03/QJR7dadPhoMef5xUVacc8mVqnGg/</id>
    <published>2024-03-03T10:49:16.000Z</published>
    <updated>2024-03-03T10:50:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="èµ·å› "><a href="#èµ·å› " class="headerlink" title="èµ·å› "></a>èµ·å› </h2><p>ä¹‹å‰å¬åˆ°ç¾¤é‡Œæœ‰äººåœ¨é—®æ¡ä»¶å˜é‡çš„å®ç°ï¼Œå‘ç°è‡ªå·±å¯¹è¿™æ–¹é¢ä¸€æ— æ‰€çŸ¥ã€‚<br><img src="/images/OYlxbkXGfo4geHxkLPicyw8Wnke.jpeg" alt="image"></p><h2 id="å…ˆå¤ä¹ ä¸€ä¸‹-xv6"><a href="#å…ˆå¤ä¹ ä¸€ä¸‹-xv6" class="headerlink" title="å…ˆå¤ä¹ ä¸€ä¸‹ xv6"></a>å…ˆå¤ä¹ ä¸€ä¸‹ xv6</h2><p>å†…æ ¸ä¸­ç”¨åˆ°äº†ä¸¤ç§é”ï¼Œè‡ªæ—‹é”å’Œç¡çœ é”ã€‚</p><h3 id="è‡ªæ—‹é”"><a href="#è‡ªæ—‹é”" class="headerlink" title="è‡ªæ—‹é”"></a>è‡ªæ—‹é”</h3><p>å…ˆçœ‹çœ‹å®ç°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Acquire the lock.</span></span><br><span class="line"><span class="comment">// Loops (spins) until the lock is acquired.</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">acquire</span><span class="params">(<span class="keyword">struct</span> spinlock *lk)</span></span><br><span class="line">&#123;</span><br><span class="line">  push_off(); <span class="comment">// disable interrupts to avoid deadlock.</span></span><br><span class="line">  <span class="keyword">if</span>(holding(lk))</span><br><span class="line">    panic(<span class="string">&quot;acquire&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// On RISC-V, sync_lock_test_and_set turns into an atomic swap:</span></span><br><span class="line">  <span class="comment">//   a5 = 1</span></span><br><span class="line">  <span class="comment">//   s1 = &amp;lk-&gt;locked</span></span><br><span class="line">  <span class="comment">//   amoswap.w.aq a5, a5, (s1)</span></span><br><span class="line">  <span class="keyword">while</span>(__sync_lock_test_and_set(&amp;lk-&gt;locked, <span class="number">1</span>) != <span class="number">0</span>)</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Tell the C compiler and the processor to not move loads or stores</span></span><br><span class="line">  <span class="comment">// past this point, to ensure that the critical section&#x27;s memory</span></span><br><span class="line">  <span class="comment">// references happen strictly after the lock is acquired.</span></span><br><span class="line">  <span class="comment">// On RISC-V, this emits a fence instruction.</span></span><br><span class="line">  __sync_synchronize();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Record info about lock acquisition for holding() and debugging.</span></span><br><span class="line">  lk-&gt;cpu = mycpu();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Release the lock.</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">release</span><span class="params">(<span class="keyword">struct</span> spinlock *lk)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span>(!holding(lk))</span><br><span class="line">    panic(<span class="string">&quot;release&quot;</span>);</span><br><span class="line"></span><br><span class="line">  lk-&gt;cpu = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Tell the C compiler and the CPU to not move loads or stores</span></span><br><span class="line">  <span class="comment">// past this point, to ensure that all the stores in the critical</span></span><br><span class="line">  <span class="comment">// section are visible to other CPUs before the lock is released,</span></span><br><span class="line">  <span class="comment">// and that loads in the critical section occur strictly before</span></span><br><span class="line">  <span class="comment">// the lock is released.</span></span><br><span class="line">  <span class="comment">// On RISC-V, this emits a fence instruction.</span></span><br><span class="line">  __sync_synchronize();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Release the lock, equivalent to lk-&gt;locked = 0.</span></span><br><span class="line">  <span class="comment">// This code doesn&#x27;t use a C assignment, since the C standard</span></span><br><span class="line">  <span class="comment">// implies that an assignment might be implemented with</span></span><br><span class="line">  <span class="comment">// multiple store instructions.</span></span><br><span class="line">  <span class="comment">// On RISC-V, sync_lock_release turns into an atomic swap:</span></span><br><span class="line">  <span class="comment">//   s1 = &amp;lk-&gt;locked</span></span><br><span class="line">  <span class="comment">//   amoswap.w zero, zero, (s1)</span></span><br><span class="line">  __sync_lock_release(&amp;lk-&gt;locked);</span><br><span class="line"></span><br><span class="line">  pop_off();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºè‡ªæ—‹é”æ˜¯åŸºäºæŒ‡ä»¤é›†æä¾›çš„åŸå­ compare and swap æ“ä½œå®ç°çš„ï¼Œå¦‚æœå­˜åœ¨é”ç«äº‰çš„æƒ…å†µï¼Œæ²¡æœ‰è·å–åˆ°é”çš„ä¸€ä¾§ä¼šè‡ªæ—‹ç­‰åˆ°é”çš„é‡Šæ”¾ã€‚</p><h3 id="ç¡çœ é”"><a href="#ç¡çœ é”" class="headerlink" title="ç¡çœ é”"></a>ç¡çœ é”</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">acquiresleep</span><span class="params">(<span class="keyword">struct</span> sleeplock *lk)</span></span><br><span class="line">&#123;</span><br><span class="line">  acquire(&amp;lk-&gt;lk);</span><br><span class="line">  <span class="keyword">while</span> (lk-&gt;locked) &#123;</span><br><span class="line">    sleep(lk, &amp;lk-&gt;lk);</span><br><span class="line">  &#125;</span><br><span class="line">  lk-&gt;locked = <span class="number">1</span>;</span><br><span class="line">  lk-&gt;pid = myproc()-&gt;pid;</span><br><span class="line">  release(&amp;lk-&gt;lk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">releasesleep</span><span class="params">(<span class="keyword">struct</span> sleeplock *lk)</span></span><br><span class="line">&#123;</span><br><span class="line">  acquire(&amp;lk-&gt;lk);</span><br><span class="line">  lk-&gt;locked = <span class="number">0</span>;</span><br><span class="line">  lk-&gt;pid = <span class="number">0</span>;</span><br><span class="line">  wakeup(lk);</span><br><span class="line">  release(&amp;lk-&gt;lk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Atomically release lock and sleep on chan.</span></span><br><span class="line"><span class="comment">// Reacquires lock when awakened.</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">sleep</span><span class="params">(<span class="type">void</span> *chan, <span class="keyword">struct</span> spinlock *lk)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Must acquire p-&gt;lock in order to</span></span><br><span class="line">  <span class="comment">// change p-&gt;state and then call sched.</span></span><br><span class="line">  <span class="comment">// Once we hold p-&gt;lock, we can be</span></span><br><span class="line">  <span class="comment">// guaranteed that we won&#x27;t miss any wakeup</span></span><br><span class="line">  <span class="comment">// (wakeup locks p-&gt;lock),</span></span><br><span class="line">  <span class="comment">// so it&#x27;s okay to release lk.</span></span><br><span class="line"></span><br><span class="line">  acquire(&amp;p-&gt;lock);  <span class="comment">//DOC: sleeplock1</span></span><br><span class="line">  release(lk);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Go to sleep.</span></span><br><span class="line">  p-&gt;chan = chan;</span><br><span class="line">  p-&gt;state = SLEEPING;</span><br><span class="line"></span><br><span class="line">  sched();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Tidy up.</span></span><br><span class="line">  p-&gt;chan = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Reacquire original lock.</span></span><br><span class="line">  release(&amp;p-&gt;lock);</span><br><span class="line">  acquire(lk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Wake up all processes sleeping on chan.</span></span><br><span class="line"><span class="comment">// Must be called without any p-&gt;lock.</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">wakeup</span><span class="params">(<span class="type">void</span> *chan)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(p = proc; p &lt; &amp;proc[NPROC]; p++) &#123;</span><br><span class="line">    <span class="keyword">if</span>(p != myproc())&#123;</span><br><span class="line">      acquire(&amp;p-&gt;lock);</span><br><span class="line">      <span class="keyword">if</span>(p-&gt;state == SLEEPING &amp;&amp; p-&gt;chan == chan) &#123;</span><br><span class="line">        p-&gt;state = RUNNABLE;</span><br><span class="line">      &#125;</span><br><span class="line">      release(&amp;p-&gt;lock);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¾ˆç®€å•ï¼Œé€šè¿‡è‡ªæ—‹é”ç¡®ä¿ä¿®æ”¹é”çŠ¶æ€æ“ä½œçš„åŸå­æ€§ã€‚å‘ç°å­˜åœ¨ç«äº‰å°±ç›´æ¥ sleepï¼Œæ‹¿åˆ°é”çš„ routine åœ¨é‡Šæ”¾é”æ—¶ä¼šä¿®æ”¹åŒä¸€æ¡ channel ä¸Šï¼ˆå°±æ˜¯åœ¨ç­‰å¾…åŒä¸€æŠŠç¡çœ é”çš„è¿›ç¨‹ï¼‰çš„è¿›ç¨‹çš„ pcb çŠ¶æ€åˆ° runnable ç­‰å¾…å†…æ ¸è°ƒåº¦ã€‚</p><p>å¯ä»¥çœ‹å‡ºè¿™é‡Œçš„å®ç°ç›¸å½“ç±»ä¼¼äº condition variableã€‚</p><h2 id="Mutex-å®ç°"><a href="#Mutex-å®ç°" class="headerlink" title="Mutex å®ç°"></a>Mutex å®ç°</h2><p>æˆ‘ä»¬çœ‹çœ‹ musl ä¸­ pthread mutex api çš„å®ç°</p><h3 id="pthread-mutex-lock"><a href="#pthread-mutex-lock" class="headerlink" title="pthread_mutex_lock"></a>pthread_mutex_lock</h3><p>è¿™é‡Œæˆ‘åªç ”ç©¶é»˜è®¤æƒ…å†µä¸‹çš„é“¾è·¯ <code>PTHREAD_MUTEX_NORMAL</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __pthread_mutex_lock(<span class="type">pthread_mutex_t</span> *m)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ((m-&gt;_m_type&amp;<span class="number">15</span>) == PTHREAD_MUTEX_NORMAL</span><br><span class="line">        &amp;&amp; !a_cas(&amp;m-&gt;_m_lock, <span class="number">0</span>, EBUSY))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> __pthread_mutex_timedlock(m, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> __pthread_mutex_timedlock(<span class="type">pthread_mutex_t</span> *<span class="keyword">restrict</span> m, <span class="type">const</span> <span class="keyword">struct</span> timespec *<span class="keyword">restrict</span> at)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ((m-&gt;_m_type&amp;<span class="number">15</span>) == PTHREAD_MUTEX_NORMAL</span><br><span class="line">        &amp;&amp; !a_cas(&amp;m-&gt;_m_lock, <span class="number">0</span>, EBUSY))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> type = m-&gt;_m_type;</span><br><span class="line">    <span class="type">int</span> r, t, priv = (type &amp; <span class="number">128</span>) ^ <span class="number">128</span>;</span><br><span class="line"></span><br><span class="line">    r = __pthread_mutex_trylock(m);</span><br><span class="line">    <span class="keyword">if</span> (r != EBUSY) <span class="keyword">return</span> r;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (type&amp;<span class="number">8</span>) <span class="keyword">return</span> pthread_mutex_timedlock_pi(m, at);</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> spins = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">while</span> (spins-- &amp;&amp; m-&gt;_m_lock &amp;&amp; !m-&gt;_m_waiters) a_spin();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((r=__pthread_mutex_trylock(m)) == EBUSY) &#123;</span><br><span class="line">        r = m-&gt;_m_lock;</span><br><span class="line">        <span class="type">int</span> own = r &amp; <span class="number">0x3fffffff</span>;</span><br><span class="line">        <span class="keyword">if</span> (!own &amp;&amp; (!r || (type&amp;<span class="number">4</span>)))</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> ((type&amp;<span class="number">3</span>) == PTHREAD_MUTEX_ERRORCHECK</span><br><span class="line">            &amp;&amp; own == __pthread_self()-&gt;tid)</span><br><span class="line">            <span class="keyword">return</span> EDEADLK;</span><br><span class="line"></span><br><span class="line">        a_inc(&amp;m-&gt;_m_waiters);</span><br><span class="line">        t = r | <span class="number">0x80000000</span>;</span><br><span class="line">        a_cas(&amp;m-&gt;_m_lock, r, t);</span><br><span class="line">        r = __timedwait(&amp;m-&gt;_m_lock, t, CLOCK_REALTIME, at, priv);</span><br><span class="line">        a_dec(&amp;m-&gt;_m_waiters);</span><br><span class="line">        <span class="keyword">if</span> (r &amp;&amp; r != EINTR) <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°±æ˜¯ç»´æŠ¤äº†ä¸€ä¸ª waiter listï¼Œè·Ÿ xv6 ç¡çœ é”çš„å®ç°å…¶å®å¹¶æ²¡æœ‰å¾ˆå¤§åŒºåˆ«</p><h2 id="Condition-Variable-å®ç°"><a href="#Condition-Variable-å®ç°" class="headerlink" title="Condition Variable å®ç°"></a>Condition Variable å®ç°</h2><p>æ¯”è¾ƒå¤æ—©çš„å®ç°æ˜¯æ¯ä¸ªæ¡ä»¶å˜é‡ç»´æŠ¤ä¸€ä¸ª waiter listï¼Œåˆ©ç”¨ä¿¡å·å”¤é†’è¿›ç¨‹ï¼ˆlinuxthreadsï¼‰</p><p>Musl çš„å®ç°æ˜¯ç›´æ¥ä½¿ç”¨ <a href="https://man7.org/linux/man-pages/man2/futex.2.html">futex</a> ç³»ç»Ÿè°ƒç”¨ï¼Œä½¿ç”¨ä¿¡å·å”¤é†’çº¿ç¨‹çš„å¼€é”€ä¸å¯è°“ä¸å¤§ï¼Œå°†å®ç°ç§»åˆ°å†…æ ¸ä¸­å†å°è£…æˆç³»ç»Ÿè°ƒç”¨ä¼šå¥½ä¸å°‘ã€‚<br><img src="/images/FckhbLAWmoLDFoxJqrrcp0QYnIg.png" alt="image"><br><img src="/images/QnT9bKtwBoM6xuxERfac2lmjnvf.png" alt="image"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;èµ·å› &quot;&gt;&lt;a href=&quot;#èµ·å› &quot; class=&quot;headerlink&quot; title=&quot;èµ·å› &quot;&gt;&lt;/a&gt;èµ·å› &lt;/h2&gt;&lt;p&gt;ä¹‹å‰å¬åˆ°ç¾¤é‡Œæœ‰äººåœ¨é—®æ¡ä»¶å˜é‡çš„å®ç°ï¼Œå‘ç°è‡ªå·±å¯¹è¿™æ–¹é¢ä¸€æ— æ‰€çŸ¥ã€‚&lt;br&gt;&lt;img src=&quot;/images/OYlxbkXGfo4geHxkL</summary>
      
    
    
    
    <category term="ç¬”è®°" scheme="http://blog.coldrain.ink/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="xv6" scheme="http://blog.coldrain.ink/tags/xv6/"/>
    
    <category term="linux" scheme="http://blog.coldrain.ink/tags/linux/"/>
    
    <category term="libc" scheme="http://blog.coldrain.ink/tags/libc/"/>
    
    <category term="å¹¶å‘" scheme="http://blog.coldrain.ink/tags/%E5%B9%B6%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>åšå®¢å†™ä½œéƒ¨ç½²åˆ†ç¦»å®è·µ</title>
    <link href="http://blog.coldrain.ink/2024/01/18/GcC9d15VKoMKpixcYB5cPntunsf/"/>
    <id>http://blog.coldrain.ink/2024/01/18/GcC9d15VKoMKpixcYB5cPntunsf/</id>
    <published>2024-01-18T08:10:27.000Z</published>
    <updated>2024-01-18T09:11:56.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä½¿ç”¨äº† <a href="https://elog.1874.cool/">Elog</a> ä¸€é”®åŒæ­¥é£ä¹¦æ–‡æ¡£ä¸Šç¼–å†™çš„åšå®¢æ–‡ç« åˆ° hexo ä»“åº“ï¼Œä»¥ååšæ–‡è¿ç§»åˆ°é£ä¹¦æ–‡æ¡£ä¸Šç¼–å†™ã€‚</p><p>å‘ç°è¿™ç©æ„å¥½åƒä¹Ÿä¸æ˜¯å¾ˆå¥½ç”¨ï¼Œæ„Ÿè§‰å¯ä»¥è‡ªå·±å†™ä¸€ä¸ªã€‚ä¸è¿‡æ„Ÿè§‰æœ‰ç‚¹æµªè´¹æ—¶é—´ï¼Œç®—äº†ã€‚</p><blockquote><p>è¯¥åšæ–‡åŒæ­¥è‡ªé£ä¹¦æ–‡æ¡£</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ä½¿ç”¨äº† &lt;a href=&quot;https://elog.1874.cool/&quot;&gt;Elog&lt;/a&gt; ä¸€é”®åŒæ­¥é£ä¹¦æ–‡æ¡£ä¸Šç¼–å†™çš„åšå®¢æ–‡ç« åˆ° hexo ä»“åº“ï¼Œä»¥ååšæ–‡è¿ç§»åˆ°é£ä¹¦æ–‡æ¡£ä¸Šç¼–å†™ã€‚&lt;/p&gt;
&lt;p&gt;å‘ç°è¿™ç©æ„å¥½åƒä¹Ÿä¸æ˜¯å¾ˆå¥½ç”¨ï¼Œæ„Ÿè§‰å¯ä»¥è‡ªå·±å†™ä¸€ä¸ªã€‚ä¸è¿‡æ„Ÿè§‰æœ‰ç‚¹æµªè´¹æ—¶é—´ï¼Œç®—äº†ã€‚&lt;/p</summary>
      
    
    
    
    
    <category term="éšç¬”" scheme="http://blog.coldrain.ink/tags/%E9%9A%8F%E7%AC%94/"/>
    
  </entry>
  
  <entry>
    <title>2023å¹´åº¦æ€»ç»“</title>
    <link href="http://blog.coldrain.ink/2023/12/30/Ehapd5iqkom3e3xScJUcxPB7nfe/"/>
    <id>http://blog.coldrain.ink/2023/12/30/Ehapd5iqkom3e3xScJUcxPB7nfe/</id>
    <published>2023-12-30T18:22:00.000Z</published>
    <updated>2024-01-18T09:11:31.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="CS-å…¬å¼€è¯¾"><a href="#CS-å…¬å¼€è¯¾" class="headerlink" title="CS å…¬å¼€è¯¾"></a><strong>CS å…¬å¼€è¯¾</strong></h2><ul><li><p>åŒ—å¤§ç¼–è¯‘å®è·µ</p><ul><li>ç®—æ˜¯ç¼–è¯‘å™¨æ–¹é¢çš„ä¸€ä¸ªå¯è’™ï¼Œä¸è¿‡æ„Ÿè§‰è¿å…¥é—¨éƒ½ç®—ä¸ä¸Š</li></ul></li><li><p>CMU 15-213 CSAPP</p><ul><li>å…¶å®è¯¾åˆ·å¾—æœ‰ç‚¹é©¬è™ï¼Œä¸è¿‡æŠŠ lab è¿‡å®Œäº†<ul><li>è¿™è¯¾æ—©æ™šå¾—å†è¿‡ä¸€é</li></ul></li></ul></li><li><p>MIT 6.S081</p><ul><li>å¯¹ç³»ç»Ÿå†…æ ¸ç†è§£ 0 çš„çªç ´ï¼Œä¹Ÿå­¦ç€è¯»äº†ä¸€äº›è‹±æ–‡è®ºæ–‡</li></ul></li><li><p>å‚åŠ äº†æ¸…åç»„ç»‡çš„ rcore å¼€æºæ“ä½œç³»ç»Ÿè®­ç»ƒè¥ï¼Œæ··äº†ä¸ªç»“è¥è¯ä¹¦</p><ul><li>å› ä¸ºæ˜¯å®ä¹ æœŸé—´åšçš„ï¼Œæ‰€ä»¥å…¶å®æœ‰ç‚¹æ°´ï¼Œä¸è¿‡å®éªŒéƒ½åšå®Œäº†ï¼Œä¹Ÿå­¦äº†ä¸€äº›å·¥ç¨‹é¡¹ç›®ä¸­å†…æ ¸çš„è°ƒè¯•æ–¹æ³•ï¼Œä¹Ÿä¸ç®—æ¯«æ— æ”¶è·<ul><li>å¤ä¹ äº†ä¸€ä¸‹ Rust</li></ul></li></ul></li><li><p>CS106X ï¼ˆæ­£åœ¨å­¦ä¹ ï¼‰</p><ul><li>æœ¬æ„æ˜¯æƒ³è¿‡ä¸€é cppï¼Œåæ¥å‘ç°å…¶å®åŸºç¡€çš„ç®—æ³•å’Œæ•°æ®ç»“æ„è®²å¾—æ›´å¤šã€‚<ul><li>ä¸è¿‡å¬ç€æ„Ÿè§‰ä¹Ÿä¸é”™ï¼Œå·©å›ºä¸‹åŸºç¡€ï¼Œå¯¹ä»¥ååšåŠ›æ‰£é¢˜ä¹Ÿå¾ˆæœ‰å¸®åŠ©ã€‚</li></ul></li></ul></li><li><p>å‚åŠ äº†è¾¾å¦ç§‘æŠ€çš„ MIT ä½“ç³»ç»“æ„å…¬å¼€è¯¾å¼€æºå­¦ä¹ ç¤¾åŒºï¼Œç°åœ¨åœ¨çœ‹ MIT 6.004</p><ul><li><p>ä¼šå­¦ Bluespecï¼Œlab æ˜¯åš MIT 6.175 çš„ï¼Œå†…å®¹æ˜¯ç”¨ bluespec æ“é¢— RISC-V CPU</p></li><li><p>çœŸæ“å‡ºæ¥äº†æƒ³åœ¨ä¸Šé¢è·‘ rcoreï¼ˆ_æˆ‘çš„å¤©ï¼Œè¿˜æœ‰æ¯”åœ¨è‡ªå·±å†™çš„ CPU ä¸Šè·‘è‡ªå·±å†™çš„ç³»ç»Ÿå†…æ ¸æ›´é…·çš„äº‹æƒ…å—_ï¼‰</p></li></ul></li></ul><p>çŒ›ç„¶å‘ç° 2023 æ˜¯æˆ‘çš„ CS å¯è’™ä¸€å¹´ï¼Œ2022 çš„æˆ‘åœ¨é€šè¿‡çº¢å²©ç½‘æ ¡çš„è€ƒæ ¸åä¾¿é™·å…¥äº†è¿·èŒ«ã€‚ä¸€è¾¹ç»´æŒç€æ‘†çƒ‚çŠ¶æ€ï¼Œä¸€è¾¹æ¼«æ— ç›®çš„çš„å€’è…¾ç€è‡ªå·±æ„Ÿå…´è¶£çš„å°ä¸œè¥¿ã€‚è¿™æœŸé—´ç¬¬ä¸€æ¬¡ç³»ç»Ÿå­¦äº† Rustï¼Œç„¶åå‘ç°äº†åŒ—å¤§çš„ç¼–è¯‘å®è·µ labã€‚åšå®Œä»¥åå¯¹ç¼–è¯‘å™¨ç›¸å…³çš„çŸ¥è¯†äº§ç”Ÿäº†å…´è¶£ï¼Œæƒ³è¦ç³»ç»Ÿçš„å­¦ä¹ ï¼Œäºæ˜¯æˆ‘ç¬¬ä¸€æ¬¡äº†è§£åˆ°å›½å¤–çš„å…¬å¼€è¯¾ ï¼ˆStanford CS143ï¼‰ã€‚</p><p>å…¶å®å¹´åˆæ˜¯æƒ³ç³»ç»Ÿçš„å­¦ä¸‹ç¼–è¯‘åŸç†ï¼ˆStanford CS143ï¼‰çš„ï¼Œä¸è¿‡åŠé€”è€ŒåºŸäº†ã€‚ä¸è¿‡åœ¨æ±‚å­¦çš„é€”ä¸­å¬äººåŠå‘Šå»å­¦äº† CSAPPï¼Œä¹‹åä¾¿ä¸€å‘ä¸å¯æ”¶æ‹¾ã€‚</p><p>å½“ç„¶æˆ‘å¯¹ä»Šå¹´çš„å­¦ä¹ è¿›åº¦å¹¶ä¸æ»¡æ„ï¼Œå®åœ¨å¤ªæ…¢å¤ªæ‘¸äº†ã€‚æ¥ä¸‹æ¥è®¡åˆ’è¦å­¦çš„å…¬å¼€è¯¾å·²ç»å †ç§¯å¦‚å±±äº†ï¼š</p><ul><li><p>CS106L ç°ä»£cpp</p></li><li><p>CMU 15-445 æ•°æ®åº“ç³»ç»Ÿ</p></li><li><p>MIT 6.824 åˆ†å¸ƒå¼ç³»ç»Ÿ</p></li><li><p>CS162 æ“ä½œç³»ç»Ÿå†…æ ¸</p></li><li><p>CS144 è®¡ç®—æœºç½‘ç»œ</p></li><li><p>CS143 ç¼–è¯‘åŸç†</p></li></ul><p>ä»»é‡è€Œé“è¿œå•Š</p><h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a><strong>å…¶ä»–</strong></h2><ul><li><p>å»äº†å¿«æ‰‹å®ä¹ </p><ul><li>å—¯ï¼Œè™½ç„¶åšçš„éƒ½æ˜¯ä¸€äº›åƒæ¬ç –ä¸€æ ·çš„ä¸šåŠ¡å¼€å‘ï¼ŒæŠ€æœ¯ä¸Šå­¦ä¸åˆ°ä»€ä¹ˆä¸œè¥¿ã€‚ä¸è¿‡è‡³å°‘äº†è§£äº†äº’è”ç½‘å¤§å‚é¡¹ç›®çš„å¼€å‘æµç¨‹ï¼Œå¹¶ä¸”åœ¨è§£å†³å…·ä½“é—®é¢˜çš„èƒ½åŠ›ï¼ˆå®šä½é—®é¢˜ï¼Œdebugï¼Œå¼€å‘ä¸šåŠ¡åŠŸèƒ½ï¼‰ä¸Šæœ‰äº†é•¿è¶³çš„è¿›æ­¥ã€‚<ul><li>æœ‰äº†è¿™ä¸€æ®µå®ä¹ ç»å†ï¼Œä¹‹å Android å¼€å‘æ–¹å‘çš„è½¬æ­£å®ä¹ åº”è¯¥å°±ä¸éš¾æ‰¾äº†ï¼Œç®—æ˜¯ç»™è‡ªå·±ç•™äº†æ¡åè·¯</li><li>ç¬¬ä¸€æ¬¡å‰å¾€å¼‚ä¹¡ç§Ÿæˆ¿ä½ï¼Œè§è¯†äº†åŒ—äº¬æµ®å¤¸çš„æˆ¿ä»·</li></ul></li></ul></li><li><p>æ€æƒ³ä¸Šå‘ç”Ÿäº†è½¬å˜</p><ul><li>ç»è¿‡ä»Šå¹´å‘ç”Ÿçš„äº‹æƒ…å’Œæˆ‘è‡ªå·±çš„ä¸€äº›æ€è€ƒï¼š<ul><li>æ›´æ„¿æ„ç›¸ä¿¡è‡ªç”±å¸‚åœº<ul><li>æ›´åŠ å¿§è™‘è‡ªå·±çš„æœªæ¥ï¼Œæƒ³è¦è½»æ¾çš„æ´»ç€ï¼Œåšè‡ªå·±æƒ³åšçš„äº‹æƒ…</li></ul></li></ul></li></ul></li><li><p>å› ä¸º MyGo å…¥å‘äº†é‚¦é‚¦ï¼Œå¹¶ä¸”åœ¨çœ‹å®Œåçš„æ•°ä¸ªæœˆå†…å¿µå¿µä¸å¿˜</p><ul><li>ä½ èƒ½çœ‹çœ‹ MyGo å—ï¼Œæˆ‘ä»€ä¹ˆéƒ½ä¼šåšçš„ğŸ˜­</li></ul></li></ul><p>æœ€åè¯´è¯´æˆ‘ç›®å‰çš„ç›®æ ‡å§ï¼Œå°½å¯èƒ½å¤šçš„å­¦ä¹  CS çŸ¥è¯†ï¼Œæ‰¾ä¸€ä¸ªåšåŸºç¡€è½¯ä»¶ç ”å‘çš„å®ä¹ ï¼Œä»¥æ­¤ä¸ºå¥‘æœºç¡®å®šæœªæ¥çš„èŒä¸šå‘å±•æ–¹å‘ã€‚å½“ç„¶è¦æ˜¯åšä¸åˆ°ä¹Ÿèƒ½æ»šå›å»åš Android å¼€å‘ï¼Œè‡³å°‘è¿˜æœ‰æ¡åè·¯ã€‚</p><p>é‚£ä¹ˆï¼Œå°±è¿™æ ·å§ï¼Œå¸Œæœ› 2024 ç»“æŸæ—¶èƒ½ç»™è‡ªå·±ä¸€ä¸ªæ»¡æ„çš„ç­”å¤ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;CS-å…¬å¼€è¯¾&quot;&gt;&lt;a href=&quot;#CS-å…¬å¼€è¯¾&quot; class=&quot;headerlink&quot; title=&quot;CS å…¬å¼€è¯¾&quot;&gt;&lt;/a&gt;&lt;strong&gt;CS å…¬å¼€è¯¾&lt;/strong&gt;&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;åŒ—å¤§ç¼–è¯‘å®è·µ&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç®—æ˜¯ç¼–è¯‘å™¨æ–¹é¢çš„</summary>
      
    
    
    
    
    <category term="å¹´åº¦æ€»ç»“" scheme="http://blog.coldrain.ink/tags/%E5%B9%B4%E5%BA%A6%E6%80%BB%E7%BB%93/"/>
    
    <category term="éšç¬”" scheme="http://blog.coldrain.ink/tags/%E9%9A%8F%E7%AC%94/"/>
    
  </entry>
  
  <entry>
    <title>å‘¨æŠ¥</title>
    <link href="http://blog.coldrain.ink/2023/12/25/FashdhbmXovCtwxNwgHckhrunRt/"/>
    <id>http://blog.coldrain.ink/2023/12/25/FashdhbmXovCtwxNwgHckhrunRt/</id>
    <published>2023-12-25T04:25:01.000Z</published>
    <updated>2024-01-18T09:31:25.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="2023-12-18-12-24"><a href="#2023-12-18-12-24" class="headerlink" title="2023.12.18~12.24"></a>2023.12.18~12.24</h1><p>å› ä¸ºæ¸¸æˆè´¦å·è¢«å°äº†ä¸€ä¸ªæœˆæ‰€ä»¥å¼€å§‹å†™å‘¨æŠ¥ push è‡ªå·±å­¦ä¹ çš„ç¬¬ä¸€å‘¨ï¼ˆ</p><p>çœ‹åˆ°å­¦å¼Ÿåœ¨å­¦ 6.824ï¼Œè¯´å®è¯æœ‰ç‚¹æ…Œï¼ŒçœŸå¾— push ä¸€ä¸‹è‡ªå·±äº†</p><h3 id="å­¦ä¹ -amp-å·¥ä½œ"><a href="#å­¦ä¹ -amp-å·¥ä½œ" class="headerlink" title="å­¦ä¹  &amp; å·¥ä½œ"></a><strong>å­¦ä¹  &amp; å·¥ä½œ</strong></h3><ul><li><p>å®Œæˆ CS106B çš„ assignment 1ï¼Œ2</p></li><li><p>ç›®å‰ä¸ºæ­¢éƒ½æ˜¯ä¸€äº›å¾ˆç®€å•çš„å†…å®¹ï¼Œè¿˜æ²¡æœ‰æ¶‰åŠåˆ°æˆ‘æ¯”è¾ƒæƒ³å­¦çš„éƒ¨åˆ†</p></li><li><p>å‚åŠ äº†</p><p>Datenlord çš„ mit ä½“ç³»ç»“æ„å…¬å¼€è¯¾å­¦ä¹ ç¤¾åŒº</p></li><li><p>å­¦ä¹ çš„è¯¾ç¨‹æ˜¯ 6.004 6.175 6.375 ï¼Œè¿™ä¸‰é—¨è¯¾çš„çŸ¥è¯†ç‚¹é‡å¤åº¦å¾ˆé«˜ï¼Œå¤§æ¦‚åªéœ€è¦çœ‹ 6.004 çš„è¯¾ï¼Œåš 6.175 çš„ labï¼Œç©¿æ’å­¦ä¹  6.375 å³å¯</p></li><li><p>ä¸è¿‡å¤§æ¦‚ç‡ä¸ä¼šåšæŒåˆ°æœ€åï¼Œåªæ˜¯ä¸€ä¸ªå­¦ä¹ è®¡ç»„çš„å¥‘æœº</p></li><li><p>å­¦ä¹ ä½“ç³»ç»“æ„çš„è¿‡ç¨‹ä¸­ä¹Ÿä¼šå¹¶å‘è¿›è¡Œå¦ä¸€é—¨å…¬å¼€è¯¾çš„å­¦ä¹ ï¼Œç›®å‰æ˜¯ CS106Xï¼Œä¹‹åä¼šåš 445 å’Œ 824</p></li></ul><h3 id="ç”Ÿæ´»"><a href="#ç”Ÿæ´»" class="headerlink" title="ç”Ÿæ´»"></a><strong>ç”Ÿæ´»</strong></h3><ul><li>ä¹…è¿çš„ä¸‹äº†ä¸ªéŸ³æ¸¸ï¼ˆé‚¦é‚¦ï¼‰æ¥ç©ï¼Œå‘ç°äº†ä¸€é¦–<a href="https://open.spotify.com/track/0bmJzYti6K65ytyLH6VTMR?si=809fadc6c8b04a47">å¾ˆä¸é”™çš„æ›²å­</a></li></ul><h2 id="ä¸‹å‘¨è®¡åˆ’"><a href="#ä¸‹å‘¨è®¡åˆ’" class="headerlink" title="ä¸‹å‘¨è®¡åˆ’"></a><strong>ä¸‹å‘¨è®¡åˆ’</strong></h2><p>ä¸‹å‘¨å…¶å®ç¦»è€ƒè¯•å‘¨å°±å¾ˆè¿‘äº†ï¼Œæ‰€ä»¥ä¸ä¸€å®šèƒ½åšå®Œ</p><ul><li><p>è¿‡å®Œ 6.004 è®² bluespec ä¹‹å‰çš„å†…å®¹</p></li><li><p>è¿‡å®Œä¸€åŠ CS106X çš„è¯¾ï¼Œè‡³å°‘å†å®Œæˆ CS106B çš„ä¸¤ä¸ª lab</p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;2023-12-18-12-24&quot;&gt;&lt;a href=&quot;#2023-12-18-12-24&quot; class=&quot;headerlink&quot; title=&quot;2023.12.18~12.24&quot;&gt;&lt;/a&gt;2023.12.18~12.24&lt;/h1&gt;&lt;p&gt;å› ä¸ºæ¸¸æˆè´¦å·è¢«å°äº†ä¸€ä¸ªæœˆæ‰€ä»¥</summary>
      
    
    
    
    
    <category term="å‘¨æŠ¥" scheme="http://blog.coldrain.ink/tags/%E5%91%A8%E6%8A%A5/"/>
    
  </entry>
  
  <entry>
    <title>è§£å†³ bear åœ¨ MacOS ä¸­ç”Ÿæˆç©º compile_commands.json</title>
    <link href="http://blog.coldrain.ink/2023/10/21/URYldeyG7okwIlxnz6lcVpvHnqE/"/>
    <id>http://blog.coldrain.ink/2023/10/21/URYldeyG7okwIlxnz6lcVpvHnqE/</id>
    <published>2023-10-21T17:50:29.000Z</published>
    <updated>2024-01-18T17:47:10.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨åšåˆ° xv6 çš„æœ€åä¸€ä¸ª lab æ—¶ï¼Œæˆ‘ç»ˆäºå¿å—ä¸äº†æ»¡å±çš„çˆ†çº¢ï¼Œç€æ‰‹å¼€å§‹é…ç½®ä»£ç é«˜äº®ã€‚å‚è€ƒ  <a href="https://zhuanlan.zhihu.com/p/501901665">https://zhuanlan.zhihu.com/p/501901665</a> é…ç½® Intellisenseï¼Œç„¶åæˆ‘é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼š</p><blockquote><p>make clean &amp;&amp; bear â€” make qemu ç”Ÿæˆç©º compile_commands.json</p></blockquote><p>æˆ‘ google æŸ¥äº†ä¸€ä¸‹ï¼Œç›®å‰æ²¡æœ‰ä¸­æ–‡åšå®¢æåˆ°è¿™ä¸ªé—®é¢˜ã€‚æˆ‘åœ¨ Bear çš„ issue ä¸‹å‘ç°è¿™ä¸ªé—®é¢˜å·²ç»è€ç”Ÿå¸¸è°ˆäº†ï¼Œå› ä¸º linux å’Œ macos ä¸‹ bear çš„å·¥ä½œåŸç†ä¸åŒï¼š</p><blockquote><p>For your problem, here is a little background informationâ€¦ Bear works differently on Linux and Mac. On Linux it intercept the process executions with a preloaded shared object. This trick does not work on Mac. Instead it use compiler wrapper, which reports the process executionsâ€¦ The compiler wrapper interposing only works with builds, which are open to override the compiler.</p></blockquote><p>æ‰€ä»¥å…¶å®åœ¨ mac ä¸Šï¼Œbear é¢„å…ˆå‡†å¤‡äº†ä¸€ç³»åˆ—å¸¸ç”¨ç¼–è¯‘å™¨çš„wrapperã€‚</p><p><img src="/images/Aehabd73Oo6zokxkpaPcMfiWn1g.png" alt="image"></p><p>å› ä¸º xv6 ä½¿ç”¨çš„ç¼–è¯‘å™¨æ˜¯ <code>riscv-unknown-elf-gcc</code> , æ²¡æœ‰é¢„ç½®å®ƒçš„ wrapperã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨åˆ›å»ºå®ƒï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ln</span> -s /opt/homebrew/Cellar/bear/3.1.3_7/lib/bear/wrapper \\</span><br><span class="line">/opt/homebrew/Cellar/bear/3.1.3_7/lib/bear/wrapper.d/riscv-unknown-elf-gcc</span><br></pre></td></tr></table></figure><p>ç„¶å bear å°±å¯ä»¥æ­£å¸¸å·¥ä½œäº†:D</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;åœ¨åšåˆ° xv6 çš„æœ€åä¸€ä¸ª lab æ—¶ï¼Œæˆ‘ç»ˆäºå¿å—ä¸äº†æ»¡å±çš„çˆ†çº¢ï¼Œç€æ‰‹å¼€å§‹é…ç½®ä»£ç é«˜äº®ã€‚å‚è€ƒ  &lt;a href=&quot;https://zhuanlan.zhihu.com/p/501901665&quot;&gt;https://zhuanlan.zhihu.com/p/501901665&lt;/</summary>
      
    
    
    
    
    <category term="xv6" scheme="http://blog.coldrain.ink/tags/xv6/"/>
    
    <category term="ç¼–è¯‘" scheme="http://blog.coldrain.ink/tags/%E7%BC%96%E8%AF%91/"/>
    
  </entry>
  
  <entry>
    <title>virtual-memory-for-user-applications</title>
    <link href="http://blog.coldrain.ink/2023/10/20/Ro5td2HZloi6YzxPcKrc9aHbn9d/"/>
    <id>http://blog.coldrain.ink/2023/10/20/Ro5td2HZloi6YzxPcKrc9aHbn9d/</id>
    <published>2023-10-20T19:21:16.000Z</published>
    <updated>2024-01-18T17:29:35.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>MIT 6.s081 lecture 17 ä¸ªäººæ€»ç»“ç¬”è®°</p></blockquote><p>å‚è€ƒ:</p><ul><li><p><a href="https://mit-public-courses-cn-translatio.gitbook.io/mit6-s081/lec17-virtual-memory-for-applications-frans">https://mit-public-courses-cn-translatio.gitbook.io/mit6-s081/lec17-virtual-memory-for-applications-frans</a></p></li><li><p><a href="https://pdos.csail.mit.edu/6.828/2020/readings/appel-li.pdf">https://pdos.csail.mit.edu/6.828/2020/readings/appel-li.pdf</a></p></li></ul><p>ä¹‹å‰æˆ‘ä»¬çŸ¥é“ï¼Œvirtual memory çš„ page fault å·²ç»è¢«å†…æ ¸ç©å‡ºäº†èŠ±ã€‚è¿›ç¨‹ fork çš„ COW æœºåˆ¶ï¼Œè™šæ‹Ÿå†…å­˜é¡µè¡¨çš„é©±é™¤æœºåˆ¶ç­‰ç­‰ï¼Œéƒ½æ˜¯åˆ©ç”¨äº† page fault è¿™ä¸ªæœºåˆ¶å®ç°çš„ã€‚page fault å¾ˆå¥½ç”¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬èƒ½ä¸èƒ½è®©ç”¨æˆ·ç¨‹åºä¹Ÿåˆ©ç”¨ä¸Š page fault å‘¢ï¼Ÿ</p><p>ä¸ºäº†è®©ç”¨æˆ·ç¨‹åºæœ‰æ•ˆçš„åˆ©ç”¨ä¸Š page fault æœºåˆ¶ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸éœ€è¦å‘ç”¨æˆ·ç¨‹åºæä¾›ä¸€ç³»åˆ—åŸè¯­ï¼ˆprimitivesï¼‰ï¼š</p><ul><li><p>Prot1 é™ä½å•ä¸ª page çš„ accessibility (mprotect)</p></li><li><p>ProtN  é™ä½ N ä¸ª page çš„ accessibilityï¼Œä¹‹æ‰€ä»¥å•ç‹¬æå‡ºæ˜¯å› ä¸ºä¿æŠ¤å¤šä¸ª page çš„å¹³å‡å¼€é”€æ›´å° ï¼ˆåªéœ€è¦åˆ·æ–°ä¸€æ¬¡ TLBï¼‰(mprotect)</p></li><li><p>Unprot è§£é™¤å•ä¸ª page çš„ä¿æŠ¤ (mprotect)</p></li><li><p>Dirty æŸ¥çœ‹ä¸€ä¸ª page æ˜¯å¦ä¸º dirty page</p></li><li><p>map2 ä½¿å¾—ä¸€ä¸ªåº”ç”¨ç¨‹åºå¯ä»¥å°†ä¸€ä¸ªç‰¹å®šçš„ç‰©ç†å†…å­˜åœ°å€ç©ºé—´æ˜ å°„ä¸¤æ¬¡ï¼Œå¹¶ä¸”è¿™ä¸¤æ¬¡æ˜ å°„æ‹¥æœ‰ä¸åŒçš„accessability (mmap)</p></li></ul><p>æœ‰äº†è¿™äº›åŸè¯­ï¼Œç”¨æˆ·ç¨‹åºå°±å¯ä»¥åˆ©ç”¨ page fault çš„æœºåˆ¶åšä¸€äº›æ›´å¥½çš„ä¼˜åŒ–ã€‚</p><h2 id="eg-1-æ„å»ºå¤§çš„ç¼“å­˜è¡¨"><a href="#eg-1-æ„å»ºå¤§çš„ç¼“å­˜è¡¨" class="headerlink" title="eg.1 æ„å»ºå¤§çš„ç¼“å­˜è¡¨"></a><strong>eg.1 æ„å»ºå¤§çš„ç¼“å­˜è¡¨</strong></h2><p>æˆ‘ä»¬å¯ä»¥ç”¨è®¾è®¡è™šæ‹Ÿå†…å­˜é©±é™¤æœºåˆ¶çš„æ€è·¯ï¼Œåˆ©ç”¨ä¸Šé¢æåˆ°çš„æ“ä½œç³»ç»Ÿæä¾›çš„ä¸€ç³»åˆ—åŸè¯­ä½¿ç”¨æœ‰é™çš„è™šæ‹Ÿå†…å­˜æ„å»ºä¸€ä¸ªéå¸¸å¤§çš„ç¼“å­˜è¡¨ã€‚</p><p>ä¸‹é¢æä¾›ä¸€ä¸ªæ¯”è¾ƒæç«¯çš„ä»£ç ç¤ºä¾‹â€”â€”åªä½¿ç”¨ä¸€é¡µè™šæ‹Ÿå†…å­˜å®ç°çš„ç¼“å­˜è¡¨</p><p><img src="/images/HHCzb2S1eoJIwOxYKkjcQAzRnrY.png" alt="image"></p><p><img src="/images/HNkJb2c3KoNEwjxUN09cvEXjn2f.png" alt="image"></p><p><img src="/images/M3ECbky79odXDkxrPwkc4hO4n3d.png" alt="image"></p><p><img src="/images/UJuvbnwDHo4ltYxm4kzcVE4xnCg.png" alt="image"></p><h2 id="eg-2-Bakerâ€™s-Real-Time-Copying-Garbage-Collector"><a href="#eg-2-Bakerâ€™s-Real-Time-Copying-Garbage-Collector" class="headerlink" title="eg.2 Bakerâ€™s Real-Time Copying Garbage Collector"></a><strong>eg.2 Bakerâ€™s Real-Time Copying Garbage Collector</strong></h2><blockquote><p>ä»¥å‰èƒŒè¿‡ä¸€äº›å…³äº GC çš„ Java å…«è‚¡æ–‡ï¼Œæ²¡æƒ³åˆ°ä¼šåœ¨è¿™é‡Œå†æ¥è§¦åˆ°è¿™ä¸ªè¯é¢˜</p></blockquote><p>æˆ‘ä»¬å…ˆè®¨è®ºä¸€ç§ç‰¹å®šçš„ copying GCï¼Œå‡è®¾ä½ æœ‰ä¸€æ®µå†…å­˜ä½œä¸ºheapï¼Œåº”ç”¨ç¨‹åºä»å…¶ä¸­ç”³è¯·å†…å­˜ã€‚ä½ å°†è¿™æ®µå†…å­˜åˆ†ä¸ºä¸¤ä¸ªç©ºé—´ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯fromç©ºé—´ï¼Œå¦ä¸€ä¸ªæ˜¯toç©ºé—´ã€‚Copying GC çš„åŸºæœ¬æ€æƒ³æ˜¯å°†ä»ç„¶åœ¨ä½¿ç”¨çš„å¯¹è±¡ä» from ç©ºé—´å¤åˆ¶åˆ° to ç©ºé—´ã€‚åœ¨ to ç©ºé—´æ»¡æ—¶è¿›è¡Œç¿»è½¬ã€‚è‡³äºå¦‚ä½•è¯†åˆ«å¯¹è±¡æ˜¯å¦åœ¨ä½¿ç”¨å¯ä»¥ä½¿ç”¨å¯è¾¾æ€§åˆ†æç®—æ³•ã€‚</p><p>èƒŒè¿‡ java å…«è‚¡æ–‡çš„äººå°±çŸ¥é“ï¼Œæˆ‘ä»¬å¸Œæœ›å°½å¯èƒ½ç¼©çŸ­ copy æ‰€èŠ±çš„æ—¶é—´ï¼Œå› ä¸ºè¿™æ®µæ—¶é—´æˆ‘ä»¬éœ€è¦ stop the worldã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä¸å¯ä»¥å°† copy æ‰€èŠ±è´¹çš„æ—¶é—´æˆæœ¬å‡æ‘Šä¸€ä¸‹ï¼Œä¸è®©ç¨‹åºè§¦å‘ GC åçªå…€çš„åœé¡¿å¾ˆé•¿ä¸€æ®µæ—¶é—´ï¼Ÿ</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è®¾è®¡ COW çš„æ€è·¯æ¥åšè¿™ä»¶äº‹ï¼Œè§¦å‘ GC æ—¶æˆ‘ä»¬åª copy GC rootï¼Œå°†æ—¶é—´æˆæœ¬é™åˆ°æœ€ä½ã€‚ç„¶åæˆ‘ä»¬å°† GC root æ ‡è®°ä¸º unscanned ï¼ˆä½¿ç”¨ prot åŸè¯­é™ä½å…¶å¯è§æ€§ï¼‰ï¼Œåœ¨æˆ‘ä»¬ä¸‹æ¬¡è®¿é—® GC root æ—¶å°±ä¼šè§¦å‘ page faultï¼Œè¿›å…¥åˆ°æˆ‘ä»¬è®¾ç½®çš„ page fault handlerã€‚åœ¨ page fault handler ä¸­å°†å½“å‰é¡µä¸­çš„åœ°å€æŒ‡å‘çš„é¡µä¹Ÿ copy åˆ° to spaceï¼Œå¯¹æŒ‡é’ˆè¿›è¡Œ forwarding ï¼ˆå°±æ˜¯å°†æŒ‡é’ˆçš„æŒ‡å‘ä»åŸæœ¬åœ¨ from space çš„å†…å­˜è½¬å‘åˆ° to space çš„å†…å­˜ï¼‰ï¼Œå¹¶ä¸”å°†å…¶æ ‡è®°ä¸º unscannedã€‚ç„¶åæˆ‘ä»¬å°†æ‰«æè¿‡çš„é¡µæ ‡è®°ä¸º scannedï¼ˆä¹Ÿå°±æ˜¯å¯¹å…¶è¿›è¡Œ unprot æ“ä½œï¼‰ã€‚è¿™æ ·æˆ‘ä»¬å°±æˆåŠŸçš„å°† GC çš„æ—¶é—´æˆæœ¬åˆ†æ‘Šåˆ°äº†ç¨‹åºè¯»å†™è™šæ‹Ÿå†…å­˜çš„æ—¶å€™ã€‚</p><p>ä½†æ˜¯æ—¢ç„¶ç”¨æˆ·ç¨‹åºä¸èƒ½è®¿é—®ï¼Œè®¿é—®äº†ä¼šå¯¼è‡´ page faultï¼Œé‚£ GC çº¿ç¨‹è¦æ€ä¹ˆè®¿é—®å‘¢ï¼Ÿå½“ç„¶æˆ‘ä»¬å¯ä»¥åœ¨ page fault handler ä¸­ä½¿ç”¨ unprot æ“ä½œï¼Œä½†æ˜¯è¿™æ ·åšçš„è¯ä¼šå¯¼è‡´å¹¶å‘çš„é—®é¢˜ï¼ˆåœ¨ GC çº¿ç¨‹ unprot åå…¶ä»–ç”¨æˆ·çº¿ç¨‹è®¿é—®äº†è¿™å—å†…å­˜ï¼‰ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ map2 åŸè¯­ï¼Œå°†ä¸€å—ç‰©ç†å†…å­˜æ˜ å°„åˆ°ä¸¤å—è™šæ‹Ÿå†…å­˜åœ°å€ï¼Œä¸€å—ä¾› GC çº¿ç¨‹è¯»å†™ï¼ˆå¯è¯»å†™ï¼‰ï¼Œä¸€å—ä¾›ç”¨æˆ·çº¿ç¨‹è¯»å†™ï¼ˆunscannedçš„æƒ…å†µä¸‹ä¸å¯è¯»å†™ï¼‰ã€‚è¿™æ ·ä¾¿å®Œç¾çš„è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼ŒåŒæ—¶æˆ‘ä»¬è·å¾—äº†å¤©ç„¶çš„å¹¶å‘æ€§ï¼šå› ä¸º unscanned çŠ¶æ€ä¸‹ GC çº¿ç¨‹è¯»å†™å†…å­˜æ—¶ç”¨æˆ·çº¿ç¨‹æ— æ³•è¯»å†™è¿™å—å†…å­˜å†…å­˜ï¼Œè€Œ scanned çŠ¶æ€ä¸‹ç”¨æˆ·çº¿ç¨‹è¯»å†™å†…å­˜æ—¶ GC çº¿ç¨‹ä¸ä¼šè¯»å†™è¿™å—å†…å­˜ã€‚</p><p><a href="https://mit-public-courses-cn-translatio.gitbook.io/mit6-s081/lec17-virtual-memory-for-applications-frans/17.7-shi-yong-xu-ni-nei-cun-te-xing-de-gc-dai-ma-zhan-shi">MITçš„æ•™æˆä»¬ç”¨ C è¯­è¨€ä»£ç è¨€ç®€æ„éª‡çš„å®ç°äº†è¿™ç§ GC</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;MIT 6.s081 lecture 17 ä¸ªäººæ€»ç»“ç¬”è®°&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;å‚è€ƒ:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;a href=&quot;https://mit-public-courses-cn-translatio.gitb</summary>
      
    
    
    
    <category term="ç¬”è®°" scheme="http://blog.coldrain.ink/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="xv6" scheme="http://blog.coldrain.ink/tags/xv6/"/>
    
    <category term="å…¬å¼€è¯¾" scheme="http://blog.coldrain.ink/tags/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="MIT6.s081" scheme="http://blog.coldrain.ink/tags/MIT6-s081/"/>
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="http://blog.coldrain.ink/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    <category term="è™šæ‹Ÿå†…å­˜" scheme="http://blog.coldrain.ink/tags/%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/"/>
    
  </entry>
  
  <entry>
    <title>xv6-fs</title>
    <link href="http://blog.coldrain.ink/2023/10/17/RLSwdlgCRo68xTxoNn6caCU1nRh/"/>
    <id>http://blog.coldrain.ink/2023/10/17/RLSwdlgCRo68xTxoNn6caCU1nRh/</id>
    <published>2023-10-17T13:09:23.000Z</published>
    <updated>2024-01-18T09:32:05.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>ä¸‹æ–‡ä¸­æ²¡æœ‰å…·ä½“è¯´æ˜çš„åœºæ™¯å‡æè¿° xv6 æ–‡ä»¶ç³»ç»Ÿçš„å®ç°</p></blockquote><p>å¥½å§ æˆ‘ä»¬å°±æ¥è¯¦ç»†æ‹ä¸€æ‹ fs</p><h2 id="ç»„æˆ"><a href="#ç»„æˆ" class="headerlink" title="ç»„æˆ"></a><strong>ç»„æˆ</strong></h2><p>&#x2F;&#x2F; todo</p><h2 id="äº‹åŠ¡-Transaction"><a href="#äº‹åŠ¡-Transaction" class="headerlink" title="äº‹åŠ¡ Transaction"></a><strong>äº‹åŠ¡ Transaction</strong></h2><blockquote><p>äº‹åŠ¡åœ¨ç”¨æ•°æ®åº“çš„æ—¶å€™å°±å·²ç»ç»å¸¸ç”¨åˆ°äº†ï¼Œä½†æ˜¯æ²¡æƒ³åˆ°æ–‡ä»¶ç³»ç»Ÿä¹Ÿæœ‰äº‹åŠ¡ã€‚ä»æ–‡ä»¶ç³»ç»Ÿçš„äº‹åŠ¡å®ç°ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥ç®¡ä¸­çª¥è±¹æ•°æ®åº“çš„äº‹åŠ¡æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œæ•°æ®åº“çš„ crash recovery æ˜¯å¦‚ä½•ä¿è¯çš„ã€‚</p></blockquote><h3 id="xv6"><a href="#xv6" class="headerlink" title="xv6"></a><strong>xv6</strong></h3><p>äº‹åŠ¡çš„ä½œç”¨æ˜¯ä¿è¯ä¸€ç»„ç£ç›˜å†™æ“ä½œçš„åŸå­æ€§ ï¼ˆå³è¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥)ï¼Œä»è€Œæ”¯æŒ crash recoveryã€‚äº‹åŠ¡æ˜¯æˆ‘ä»¬å¯¹ä¸€ç»„æ•´ä½“å…·æœ‰åŸå­æ€§çš„ç£ç›˜å†™æ“ä½œçš„æŠ½è±¡ï¼Œè€Œæˆ‘ä»¬æ˜¯å¦‚ä½•å®ç°äº‹åŠ¡è¿™ä¸ªç‰¹æ€§çš„å‘¢ï¼Ÿ</p><p>å½“ç„¶æ˜¯å‡­å€Ÿæ—¥å¿—ç³»ç»Ÿã€‚åœ¨xv6ä¸­ï¼Œæˆ‘ä»¬åœ¨æ‰§è¡Œä¸€ç»„ç£ç›˜å†™æ“ä½œæ—¶ï¼Œä¼šå…ˆå°†è¿™ç»„å†™æ“ä½œå‘åˆ° block cacheã€‚block cache å°±æ˜¯ç£ç›˜ block åœ¨å†…å­˜ä¸­çš„ copyã€‚</p><p>åœ¨writeç³»ç»Ÿè°ƒç”¨çš„æœ€åï¼ˆä¹Ÿå°±æ˜¯äº‹åŠ¡ç»“æŸæ—¶ï¼‰ï¼Œè¿™äº›æ›´æ–°éƒ½è¢«ä» block cache æ‹·è´åˆ°äº† log ä¸­ï¼Œä¹‹åä¼šæ›´æ–° header block çš„è®¡æ•°æ¥è¡¨æ˜å½“å‰çš„ transaction å·²ç»ç»“æŸäº†ã€‚</p><p>æ›´æ–° header block çš„è®¡æ•°è¿™ä¸ªæ“ä½œæ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼ˆå¾—ç›Šäºç¡¬ä»¶æ”¯æŒï¼‰ï¼Œè¢«ç§°ä¸º commit pointã€‚å¦‚æœç³»ç»Ÿåœ¨ commit point ä¹‹å‰å´©æºƒï¼Œåˆ™ç›¸å½“äºäº‹åŠ¡åœ¨æ‰§è¡Œæ—¶ä¸­æ–­ï¼Œæˆ‘ä»¬ä¾¿æ”¾å¼ƒä¹‹å‰å·²æœ‰çš„å…¨éƒ¨æ›´æ”¹ã€‚ä½†å¦‚æœç³»ç»Ÿåœ¨ commit point ä¹‹åå´©æºƒï¼Œåˆ™ç›¸å½“äºäº‹åŠ¡å·²ç»æ‰§è¡Œå®Œæ¯•ï¼ˆä½†æ˜¯è¿˜æ²¡æœ‰å›æ”¶ï¼‰ã€‚è™½ç„¶æ­¤æ—¶ log ä¸­çš„å˜æ›´è¿˜æ²¡æœ‰å†™å…¥åˆ°ç£ç›˜å¯¹åº”çš„ä½ç½®ï¼Œä½†æ˜¯å³ä½¿åœ¨æ­¤æ—¶å´©æºƒé‡å¯æ—¶ä¹Ÿå¯ä»¥æ ¹æ® log ä¸­çš„è®°å½•æ¢å¤ä¹‹å‰çš„æ›´æ”¹ã€‚</p><p>commit point ä¹‹åå½“ç„¶æ˜¯å°† log ä¸­çš„å˜æ›´å†™å›ç£ç›˜ï¼Œç„¶åæ¸…é™¤ header block ä¸­çš„è®¡æ•°ï¼ˆè®¡æ•°æ¸…é™¤è¢«è§†ä½œé‡Šæ”¾äº†ä¸€ä¸ªäº‹åŠ¡ï¼‰ï¼Œè‡³æ­¤ä¸€ä¸ªäº‹åŠ¡çš„æµç¨‹å®Œæˆã€‚</p><h3 id="ext3"><a href="#ext3" class="headerlink" title="ext3"></a><strong>ext3</strong></h3><p>ext3 æ˜¯åœ¨çœŸå®ä¸–ç•Œä¸­ä½¿ç”¨çš„ä¸€ç§æ–‡ä»¶ç³»ç»Ÿå®ç°ï¼Œç›´åˆ°ç°åœ¨ä¹Ÿä»ç„¶ç»å¸¸åœ¨ linux ä¸Šä½¿ç”¨ã€‚æˆ‘ä»¬å¯ä»¥è½»æ˜“çš„åœ¨ linux ä¸Šä»¥ ext3 æ–‡ä»¶ç³»ç»Ÿçš„æ ¼å¼æŒ‚è½½ä¸€å—ç¡¬ç›˜ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/fstab <span class="comment"># åœ¨æ–‡ä»¶æœ«å°¾åŠ ä¸Š /dev/&lt;è®¾å¤‡&gt; &lt;è¦æŒ‚è½½çš„è·¯å¾„&gt; ext3 defaults 1 1</span></span><br></pre></td></tr></table></figure><p>ext3 çš„å®ç°æ€è·¯æ˜¯åŸºäº <a href="https://pdos.csail.mit.edu/6.828/2020/readings/journal-design.pdf">Journaling the Linux ext2fs Filesystem</a> ä¸­æè¿°çš„ä¸€ç§é«˜æ€§èƒ½é«˜å¯é æ–‡ä»¶ç³»ç»Ÿå®ç°ã€‚å…¶å®ç°æ–¹å¼è·Ÿ xv6 çš„æ–‡ä»¶ç³»ç»Ÿå®ç°æœ‰å¾ˆå¤šç±»ä¼¼çš„åœ°æ–¹ï¼Œä¸è¿‡å› ä¸ºå…¶ç”¨äºç°å®ä¸–ç•Œï¼Œæ‰€ä»¥æ¯” xv6 è€ƒè™‘äº†æ›´å¤šç»†èŠ‚ï¼Œä¸”æ€»ä½“ä¸Šæ€§èƒ½è¦æ›´å¥½ï¼ˆå¥½å¾—å¤šï¼‰ï¼š</p><ul><li><p>ext3 æä¾›äº†å¼‚æ­¥ç³»ç»Ÿè°ƒç”¨ ï¼Œå³ç³»ç»Ÿä¿®æ”¹å®Œ block cache å°±ç›´æ¥è¿”å›ï¼ˆæ˜¯çš„ï¼Œext3 ä¸Šçš„ write ç³»ç»Ÿè°ƒç”¨è¿”å›æ—¶æ•°æ®å…¶å®è¿˜æ²¡æœ‰è¢«å†™åˆ°ç£ç›˜ä¸Šï¼Œåœ¨è¿™ä¸ªä¸­é€” crash äº‹åŠ¡æ˜¯æœ‰å¯èƒ½å›æ»šçš„ï¼‰</p></li><li><p>ext3 æ”¯æŒæ‰¹å¤„ç† (batching) ï¼Œå³ ext3 å¯ä»¥åˆå¹¶ä¸€æ®µæ—¶é—´å†…çš„æ‰€æœ‰äº‹åŠ¡ï¼Œæœ€åå°†å…¶ä½œä¸ºä¸€ä¸ªå¤§äº‹åŠ¡è¿›è¡Œæäº¤ï¼Œè¿™æ ·åšæ•´ä½“åªä¼šå‘ç£ç›˜ä¸­å†™å…¥ä¸€æ¬¡æ•°æ®ã€‚</p><ul><li>é¦–å…ˆæ‰¹å¤„ç†å‡å°‘äº†äº‹åŠ¡å¸¦æ¥çš„å¼€é”€ï¼Œä»æœºæ¢°ç¡¬ç›˜ä¸­æŸ¥æ‰¾logçš„ä½ç½®å®é™…ä¸Šå¼€é”€ä¸å°ï¼Œè€Œæ‰¹å¤„ç†åˆå¹¶äº†å¤šä¸ªäº‹åŠ¡ï¼Œå‡å°‘äº†äº‹åŠ¡æ‰§è¡Œçš„æ¬¡æ•°ã€‚<ul><li>å¦‚æœä¹‹å‰çš„å¤šä¸ªäº‹åŠ¡ä¸­éƒ½ä¿®æ”¹äº†åŒä¸€ä¸ªblockï¼Œæ‰¹å¤„ç†åå†™å…¥ç£ç›˜æ—¶å°±åªéœ€è¦å†™å…¥ä¸€æ¬¡ (è¿™ç§æƒ…å†µè¢«ç§°ä½œ write absorbing)ï¼Œç›¸å½“äºå‡å°‘äº†ç£ç›˜ ioã€‚</li><li>æ‰¹å¤„ç†åˆ©å¥½ disk scheduling</li><li>ç£ç›˜çš„è¯»å†™ä¹Ÿæ˜¯å…·æœ‰å±€éƒ¨æ€§çš„ï¼Œä¸€æ¬¡æ€§çš„å‘ç£ç›˜çš„è¿ç»­ä½ç½®å†™å…¥1000ä¸ªblockï¼Œè¦æ¯”åˆ†1000æ¬¡æ¯æ¬¡å†™ä¸€ä¸ªä¸åŒä½ç½®çš„ç£ç›˜blockå¿«å¾—å¤šã€‚å†™logå°±æ˜¯å‘ç£ç›˜çš„è¿ç»­ä½ç½®å†™blockã€‚é€šè¿‡å‘ç£ç›˜æäº¤å¤§æ‰¹é‡çš„å†™æ“ä½œï¼Œå¯ä»¥æ›´åŠ çš„é«˜æ•ˆã€‚<ul><li>å¦‚æœèƒ½å°†å¤§é‡çš„å†™è¯·æ±‚åŒæ—¶å‘é€åˆ°é©±åŠ¨ï¼Œå³ä½¿å®ƒä»¬ä½äºç£ç›˜çš„ä¸åŒä½ç½®ï¼Œæˆ‘ä»¬ä¹Ÿä½¿å¾—ç£ç›˜å¯ä»¥è°ƒåº¦è¿™äº›å†™è¯·æ±‚ï¼Œå¹¶ä»¥ç‰¹å®šçš„é¡ºåºæ‰§è¡Œè¿™äº›å†™è¯·æ±‚ï¼Œè¿™ä¹Ÿå¾ˆæœ‰æ•ˆã€‚åœ¨ä¸€ä¸ªæœºæ¢°ç¡¬ç›˜ä¸Šï¼Œå¦‚æœä¸€æ¬¡å‘é€å¤§é‡éœ€è¦æ›´æ–°blockçš„å†™è¯·æ±‚ï¼Œé©±åŠ¨å¯ä»¥å¯¹è¿™äº›å†™è¯·æ±‚æ ¹æ®è½¨é“å·æ’åºã€‚ç”šè‡³åœ¨ä¸€ä¸ªå›ºæ€ç¡¬ç›˜ä¸­ï¼Œé€šè¿‡ä¸€æ¬¡å‘é€ç»™ç¡¬ç›˜å¤§é‡çš„æ›´æ–°æ“ä½œä¹Ÿå¯ä»¥ç¨å¾®æå‡æ€§èƒ½ã€‚æ‰€ä»¥ï¼Œåªæœ‰å‘é€ç»™é©±åŠ¨å¤§é‡çš„å†™æ“ä½œï¼Œæ‰æœ‰å¯èƒ½è·å¾—disk schedulingã€‚è¿™æ˜¯batchingå¸¦æ¥çš„å¦ä¸€ä¸ªå¥½å¤„ã€‚</li></ul></li></ul></li></ul></li><li><p>è‰¯å¥½çš„å¹¶å‘æ€§èƒ½ concurrency</p><ul><li>ext3 å…è®¸å¹¶è¡Œå†™æ“ä½œï¼Œåœ¨ä¸€ä¸ªæ€»çš„äº‹åŠ¡æäº¤ä¹‹å‰ï¼Œå…¶ä»– write ç³»ç»Ÿè°ƒç”¨ä¸å¿…ç­‰å¾…åˆ°å½“å‰äº‹åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œè€Œæ˜¯ç›´æ¥è®© write æ“ä½œåˆå¹¶åˆ°å½“å‰äº‹åŠ¡å½“ä¸­ã€‚<ul><li>å¯ä»¥æœ‰ä¸åŒçš„ transaction åŒæ—¶å­˜åœ¨ï¼Œå°½ç®¡åªæœ‰ä¸€ä¸ª open transaction å¯ä»¥æ¥æ”¶ç³»ç»Ÿè°ƒç”¨ã€‚</li><li>ä¸€ä¸ª open transaction<ul><li>è‹¥å¹²ä¸ªæ­£åœ¨commitåˆ°logçš„transactionï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦ç­‰å¾…è¿™äº›transactionç»“æŸã€‚å½“ä¹‹å‰çš„transactionè¿˜æ²¡æœ‰commitå¹¶è¿˜åœ¨å†™logçš„è¿‡ç¨‹ä¸­ï¼Œæ–°çš„ç³»ç»Ÿè°ƒç”¨ä»ç„¶å¯ä»¥åœ¨å½“å‰çš„open transactionä¸­è¿›è¡Œã€‚</li><li>è‹¥å¹²ä¸ªæ­£åœ¨ä»cacheä¸­å‘æ–‡ä»¶ç³»ç»Ÿblockå†™æ•°æ®çš„transaction</li><li>è‹¥å¹²ä¸ªæ­£åœ¨è¢«é‡Šæ”¾çš„transactionï¼Œè¿™ä¸ªå¹¶ä¸å ç”¨å¤ªå¤šçš„å·¥ä½œ</li><li>ä¹Ÿå°±æ˜¯è¯´ æäº¤äº‹åŠ¡ ï¼Œå†™å…¥ç£ç›˜ï¼Œé‡Šæ”¾äº‹åŠ¡ è¿™ä¸‰ä¸ªæ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ã€‚</li></ul></li></ul></li></ul></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;ä¸‹æ–‡ä¸­æ²¡æœ‰å…·ä½“è¯´æ˜çš„åœºæ™¯å‡æè¿° xv6 æ–‡ä»¶ç³»ç»Ÿçš„å®ç°&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;å¥½å§ æˆ‘ä»¬å°±æ¥è¯¦ç»†æ‹ä¸€æ‹ fs&lt;/p&gt;
&lt;h2 id=&quot;ç»„æˆ&quot;&gt;&lt;a href=&quot;#ç»„æˆ&quot; class=&quot;headerlink&quot; title=&quot;ç»„æˆ&quot;</summary>
      
    
    
    
    <category term="ç¬”è®°" scheme="http://blog.coldrain.ink/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="xv6" scheme="http://blog.coldrain.ink/tags/xv6/"/>
    
    <category term="å…¬å¼€è¯¾" scheme="http://blog.coldrain.ink/tags/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="MIT6.s081" scheme="http://blog.coldrain.ink/tags/MIT6-s081/"/>
    
    <category term="File System" scheme="http://blog.coldrain.ink/tags/File-System/"/>
    
  </entry>
  
  <entry>
    <title>2023ä¸ƒæœˆåˆ°ä¹æœˆæ€»ç»“</title>
    <link href="http://blog.coldrain.ink/2023/10/07/LTj7d5ZKsoQ3hRxaA9Acn3WAnUg/"/>
    <id>http://blog.coldrain.ink/2023/10/07/LTj7d5ZKsoQ3hRxaA9Acn3WAnUg/</id>
    <published>2023-10-07T14:19:19.000Z</published>
    <updated>2024-01-18T09:11:20.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="2023-7ï½9æœˆæ€»ç»“"><a href="#2023-7ï½9æœˆæ€»ç»“" class="headerlink" title="2023.7ï½9æœˆæ€»ç»“"></a><strong>2023.7ï½9æœˆæ€»ç»“</strong></h1><p>ä»åŒ—äº¬å›æ¥äº†ï¼Œå®ä¹ åŸºæœ¬ç®—å‘Šä¸€æ®µè½äº†ã€‚è‡³å°‘çº¿ä¸‹å®ä¹ å‘Šä¸€æ®µè½äº†ï¼Œèƒ½ä¸èƒ½ç»§ç»­çº¿ä¸Šè¿˜å¾—ç­‰ç»“è®ºã€‚å€Ÿæ­¤æœºä¼šæŠŠ 2023.7 ï½ 9 æœˆåšçš„äº‹æƒ…æ€»ç»“ä¸€ä¸‹ï¼š</p><h2 id="7æœˆ"><a href="#7æœˆ" class="headerlink" title="7æœˆ"></a><strong>7æœˆ</strong></h2><p>åŸæœ¬è®¡åˆ’æš‘å‡é‡Œå¥½å¥½çš„æŠŠ xv6 ç»™åˆ·äº†ï¼Œä½†æ˜¯å­¦é•¿çªç„¶ç»™äº†æˆ‘å¿«æ‰‹å®ä¹ çš„å†…æ¨ï¼Œäºæ˜¯æš‚æ—¶æç½®äº† cs çš„å­¦ä¹ ï¼Œå…¨å¿ƒå…¨æ„å‡†å¤‡é¢è¯•ã€‚ä¸€é¢è‡ªæˆ‘æ„Ÿè§‰è¿˜ç®—å¯ä»¥ï¼Œä½†å¿«æ‰‹é‚£è¾¹ä¼¼ä¹æ˜¯å› ä¸º hc çš„é—®é¢˜è¿Ÿè¿Ÿä¸è‚¯å®‰æ’äºŒé¢ï¼Œé¸½äº†æˆ‘å¾ˆé•¿ä¸€æ®µæ—¶é—´ã€‚è¿™æ®µæ—¶é—´æœ€å¼€å§‹æˆ‘æ˜¯åœ¨å‡†å¤‡é¢è¯•çš„ï¼Œç„¶è€Œç­‰äº†å¥½å‡ å¤©è¿˜æ²¡æ”¶åˆ°äºŒé¢æ¶ˆæ¯å°±é‡å¯äº† xv6 çš„å­¦ä¹ ï¼Œè®°å¾—æ˜¯ä¸€å£æ°”åšåˆ°äº† traps labï¼Œç„¶åæ”¶åˆ°äº†å¿«æ‰‹çš„æ‹’ä¿¡ã€‚</p><p>æ”¶åˆ°æ‹’ä¿¡ä¹‹åæœ¬ç€ä¸€ä¸åšäºŒä¸ä¼‘çš„åŸåˆ™åˆåœ¨ boss ç›´è˜ä¸Šæµ·æŠ•ï¼Œç„¶è€Œåªæ”¶åˆ°äº†ä¸¤å®¶å…¬å¸çš„é¢è¯•é‚€çº¦ï¼šç¦¾å¤šç§‘æŠ€ï¼Œå­—èŠ‚è·³åŠ¨ï¼ˆæŠ–éŸ³å¼€æ”¾å¹³å°ï¼‰ã€‚</p><p>ç¦¾å¤šç§‘æŠ€ä¸€é¢åªé—®äº†20åˆ†é’Ÿï¼Œéƒ½æ˜¯éå¸¸åŸºç¡€éå¸¸ç®€å•çš„é—®é¢˜ï¼ŒäºŒé¢ç›´æ¥ä¸é—®äº†ï¼Œç›´æ¥è·Ÿæˆ‘ä»‹ç»å…¬å¸ä¸šåŠ¡ï¼ˆåšè‡ªåŠ¨é©¾é©¶ï¼‰ï¼Œä½†æ˜¯å› ä¸ºåªæ˜¯éšä¾¿æŠ•æ¥ç»ƒæ‰‹çš„å°å‚ï¼Œç»™çš„å®ä¹ å·¥èµ„ä¹Ÿä¸å¤Ÿæˆ‘åœ¨åŒ—äº¬ç”Ÿæ´»ï¼Œå°±æ‹’äº†ã€‚</p><p>æŠ–éŸ³å¼€æ”¾å¹³å°é¢è¯•é—®å¾—æ¯”è¾ƒæœ‰æ°´å¹³ï¼Œå¯æƒœæˆ‘ç®—æ³•è‹¦æ‰‹ï¼Œè€Œé¢è¯•å®˜åˆæ¯”è¾ƒçœ‹é‡ç®—æ³•è¿™ä¸€å—ï¼Œå¥½æ­»ä¸æ­»ä¸€é¢äºŒé¢çš„ç®—æ³•é¢˜ä¸€é“éƒ½æ²¡æœ‰åšå‡ºæ¥ï¼Œå½“ç„¶æ˜¯æŒ‚äº†ã€‚é—®äº†ä»–ä»¬çš„ä¸šåŠ¡ï¼Œä¼¼ä¹æ˜¯åšæŠ–éŸ³å°ç¨‹åºçš„å¼€æ”¾ apiã€‚</p><h2 id="8æœˆ"><a href="#8æœˆ" class="headerlink" title="8æœˆ"></a><strong>8æœˆ</strong></h2><p>å› ä¸ºæ²¡æœ‰æ‰¾åˆ°å®ä¹ ï¼Œè·Ÿç€çˆ¶æ¯ä¸€èµ·å»è´µå·æ—…æ¸¸æ”¾æ¾ä¸€ä¸‹ã€‚è¿™æ¬¡å»è´µå·æ—…æ¸¸çš„ä½“éªŒç¡®å®å¾ˆä¸é”™ï¼Œå°è±¡æœ€æ·±åˆ»çš„æ˜¯éŸ­èœåªä¸Šçš„ä¸€å¤§ç‰‡ç´«è‰²é‡ç”ŸéŸ­èœèŠ±ï¼Œéå¸¸çš„æ¼‚äº®ã€‚</p><p>å®ä¹ çš„äº‹æƒ…åœ¨æ—…è¡Œçš„ä¸­é€”è¿æ¥äº†è½¬æœºã€‚å¿«æ‰‹çš„hråˆæ‰¾ä¸Šæˆ‘ï¼Œå‘Šè¯‰æˆ‘è¢«æŒ‚æ‰çš„åŸå› æ˜¯å½“æ—¶æ²¡æœ‰ hc äº†ï¼Œç°åœ¨åˆæœ‰ hc äº†ï¼Œå¦‚æœæˆ‘è¿˜æ„¿æ„æ¥çš„è¯å¯ä»¥ç›´æ¥ç»™æˆ‘å®‰æ’äºŒé¢ã€‚è€ŒäºŒé¢çš„é¢è¯•å®˜ï¼ˆä¹Ÿå°±æ˜¯æˆ‘åæ¥çš„ leaderï¼‰å› ä¸ºæ€¥ç€ç”¨äººï¼Œé¢è¯•ä¹Ÿæ”¾äº†ä¸å°‘æ°´ã€‚äºæ˜¯è™½ç„¶æ™šäº†äº›ï¼Œæˆ‘åœ¨ 8 æœˆ 17 å·æ­£å¼å…¥èŒäº†å¿«æ‰‹ã€‚</p><p>ä¸å¾—ä¸è¯´é‚£æ®µæ—¶é—´æˆ‘ä»¬éƒ¨é—¨ç¡®å®æ˜¯ç¼ºäººï¼Œæˆ‘åœ¨å…¥èŒååªç†Ÿæ‚‰äº†ä¸¤å¤©ä»£ç ä¾¿å¼€å§‹åšç¬¬ä¸€ä¸ªéœ€æ±‚ï¼Œmentor å¿™å¾—æ ¹æœ¬é¡¾ä¸ä¸Šæˆ‘ï¼Œæˆ‘é‡ä¸Šäº†é—®é¢˜å¤§å¤šæ•°æ—¶å€™éƒ½æ˜¯é—®å­¦é•¿ï¼ˆå¦‚æœæ²¡æœ‰å­¦é•¿åœ¨çš„è¯æˆ‘æ ¹æœ¬ä¸çŸ¥é“æ€ä¹ˆåº¦è¿‡å®ä¹ æœ€å¼€å§‹é‚£æ®µæ—¶å…‰ï¼‰ã€‚å®ä¹ ä¸¤å‘¨ä¹‹åï¼Œæˆ‘åŸºæœ¬ç†Ÿæ‚‰äº’è”ç½‘å¤§å‚äº§å“çš„å¼€å‘æµç¨‹ï¼Œå¹¶ä¸”æ„Ÿè§‰è‡ªå·±è§£å†³çœ¼å‰çš„é—®é¢˜çš„èƒ½åŠ›æœ‰äº†é•¿è¶³çš„è¿›æ­¥ã€‚</p><p>è¿™æ®µæ—¶é—´çš„å®ä¹ ç”Ÿæ´»è¿‡å¾—å¾ˆå……å®ï¼Œå¾ˆå¿«ä¹ã€‚ä¸ç”¨çƒ¦æ¼å­¦æ ¡çš„äº‹æƒ…ï¼Œè¿˜æœ‰ä¸¤ä½å­¦é•¿é™ªç€ã€‚ç„¶è€ŒåŸºæœ¬æŠ½ä¸å‡ºæ—¶é—´å­¦ xv6ï¼Œåªåœ¨å‘¨æœ«çš„æ—¶å€™å®Œæˆäº†ä¸¤ä¸ª labã€‚</p><h2 id="9æœˆ"><a href="#9æœˆ" class="headerlink" title="9æœˆ"></a><strong>9æœˆ</strong></h2><p>9æœˆä»½å­¦é•¿ä»¬å®ä¹ ç­”è¾©å®Œè¿”æ ¡äº†ï¼Œæœ‰ä¸€æ®µæ—¶é—´éƒ½æ˜¯æˆ‘è‡ªå·±ä¸€ä¸ªäººåœ¨å¿«æ‰‹å®ä¹ ã€‚æ²¡æœ‰äº†å­¦é•¿ä»¬çš„é™ªä¼´ï¼Œå®ä¹ ç”Ÿæ´»ç¡®å®å˜å¾—ä¹å‘³äº†äº›ã€‚ç„¶åå°±æ˜¯å¤„ç†ä¸€ç³»åˆ—å­¦æ ¡çš„ç ´äº‹ï¼ŒåŸæœ¬å°±æ‰“ç®—ç’ç€è¾…å¯¼å‘˜è¯·ä»£è¯¾ï¼Œç»“æœçˆ¶æ¯ä¸æ”¾å¿ƒç»™è¾…å¯¼å‘˜æ‰“äº†ç”µè¯ã€‚åŸæœ¬è¾…å¯¼å‘˜ä¹Ÿä¸æƒ³ç®¡è¿™ä¸ªäº‹æƒ…ï¼Œå¥ˆä½•è¿™å­¦æœŸæ¢äº†ä¸ªè¾…å¯¼å‘˜ï¼Œè¿™ä¸ªè¾…å¯¼å‘˜æ˜¯ä¸ƒæœˆä»½æ–°å…¥èŒçš„ï¼Œä¿—è¯è¯´æ–°å®˜ä¸Šä»»ä¸‰æŠŠç«ï¼Œå¥¹è¿™ç«ç›´æ¥çƒ§æˆ‘å¤´ä¸Šäº†ã€‚</p><p>æœ¬æ¥é‚£æ®µæ—¶é—´å·¥ä½œå°±å¿™ï¼Œå†åŠ ä¸Šæ¯å¤©æ™šä¸Šè¦å¤„ç†å­¦æ ¡çš„ç ´äº‹ï¼Œè¿‡å¾—éå¸¸çš„ç—›è‹¦ã€‚æœ¬æ¥æ˜¯æƒ³è‡³å°‘æ‹–åˆ°åæœˆæœ«å†å›å®¶ï¼Œä½†æ˜¯æ­£å·§è·Ÿå­¦é•¿ä»¬åŒç§Ÿçš„æˆ¿å­ä¹Ÿåˆ°æœŸäº†ï¼Œæ ¹æœ¬æ‰¾ä¸åˆ°èƒ½çŸ­ç§Ÿä¸€ä¸ªæœˆçš„æˆ¿å­ï¼Œå†åŠ ä¸Šçˆ¶æ¯å’Œå­¦æ ¡é‚£è¾¹ç»™çš„å‹åŠ›ï¼Œæœ€åè¿˜æ˜¯å†³å®šå›½åº†èŠ‚å°±å›æ¥ã€‚</p><p>é¡ºä¾¿æŠ¥äº†æ¸…åçš„å¼€æºæ“ä½œç³»ç»Ÿè®­ç»ƒè¥ï¼Œå…ˆæŠŠ rustlings åˆ·äº†ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a><strong>æ€»ç»“</strong></h2><p>è¿™ä¸ªæš‘å‡è¿˜æ˜¯æ²¡èƒ½é™ä¸‹å¿ƒæ¥å­¦ csï¼ŒåŸæœ¬è¿˜è®¡åˆ’æš‘å‡åšå®Œ xv6 çš„ã€‚ä¸è¿‡è‡³å°‘æœ€ç»ˆè¿˜æ˜¯æ‰¾åˆ°äº†å®ä¹ ï¼Œè§è¯†äº†ä¸€çº¿äº’è”ç½‘å¤§å‚å‘˜å·¥çš„å·¥ä½œç”Ÿæ´»çŠ¶æ€ï¼Œè¿‡å¾—ä¹Ÿç®—ä¸é”™å§ã€‚</p><p>å®ä¹ ä¹‹åçš„æ„Ÿå—å°±æ˜¯å®Œå…¨æŠ½ä¸å‡ºæ—¶é—´æ¥å­¦ä¹  csï¼Œä¸€æƒ³åˆ°æ¯•ä¸šä»¥åé¢ä¸´çš„å°±æ˜¯è¿™æ ·çš„ç”Ÿæ´»å°±æ„Ÿåˆ°éå¸¸å®³æ€•ï¼Œæƒ³å°½é‡åœ¨æ‰€å‰©ä¸å¤šçš„å¤§å­¦ç”Ÿæ´»ä¸­å¤šå­¦ä¹ ä¸€äº› cs çŸ¥è¯†ã€‚æˆ‘ä¸ç¡®å®šè¿™æ ·åšå¯¹æˆ‘æ˜¯å¥½æ˜¯åï¼Œä¹Ÿè®¸æˆ‘æ›´åº”è¯¥æŠŠæ—¶é—´èŠ±åœ¨ç ”ç©¶ android æŠ€æœ¯ä¸Šï¼Œè¿™æ ·æˆ–è®¸å¯¹æˆ‘çš„æœªæ¥çš„èŒä¸šç”Ÿæ¶¯æ›´æœ‰å¥½å¤„ã€‚</p><p>ä½†æ˜¯å­¦ä¹ å¹¶ä¸åªæ˜¯ä¸ºäº†å°±ä¸šï¼Œä¸ºäº†é’±ã€‚æˆ‘æ›´å¸Œæœ›å­¦ä¹ ä¸€äº›æ›´åº•å±‚çš„ï¼Œè‡ªå·±æ›´æ„Ÿå…´è¶£çš„çŸ¥è¯†ï¼Œå“ªæ€•åœ¨å·¥ä½œä¸Šä¹Ÿè®¸å¾ˆå°‘ç”¨åˆ°å®ƒä»¬ã€‚æˆ‘ä¸æƒ³å›ºå®ˆåœ¨ android çš„ä¸€äº©ä¸‰åˆ†åœ°é‡Œï¼Œæ›´æ„¿æ„åœ¨è®¡ç®—æœºç§‘å­¦çš„æµ·æ´‹ä¸­é¨æ¸¸ï¼Œæ¢ç´¢ã€‚</p><p>æˆ‘è¿™æ ·æƒ³æ˜¯å¯¹çš„å—ï¼Ÿå¯¹æˆ‘çš„æœªæ¥æœ‰å¥½å¤„å—ï¼Ÿæˆ‘ä¸çŸ¥é“ï¼Œä½†è‡³å°‘å¯ä»¥ç¡®å®šçš„æ˜¯æˆ‘ä»ç„¶åœ¨ä¸æ–­å‰è¿›ï¼Œå¦‚æ­¤å°±å¥½ï¼Œè¿™æ ·å°±å¥½ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;2023-7ï½9æœˆæ€»ç»“&quot;&gt;&lt;a href=&quot;#2023-7ï½9æœˆæ€»ç»“&quot; class=&quot;headerlink&quot; title=&quot;2023.7ï½9æœˆæ€»ç»“&quot;&gt;&lt;/a&gt;&lt;strong&gt;2023.7ï½9æœˆæ€»ç»“&lt;/strong&gt;&lt;/h1&gt;&lt;p&gt;ä»åŒ—äº¬å›æ¥äº†ï¼Œå®ä¹ åŸºæœ¬ç®—å‘Šä¸€æ®µè½äº†</summary>
      
    
    
    
    
    <category term="æ€»ç»“" scheme="http://blog.coldrain.ink/tags/%E6%80%BB%E7%BB%93/"/>
    
  </entry>
  
  <entry>
    <title>Handler Android æ¶ˆæ¯æœºåˆ¶</title>
    <link href="http://blog.coldrain.ink/2023/07/04/N8Ald4KgDobdVPxjhhHc76zRnVg/"/>
    <id>http://blog.coldrain.ink/2023/07/04/N8Ald4KgDobdVPxjhhHc76zRnVg/</id>
    <published>2023-07-04T12:49:55.000Z</published>
    <updated>2024-01-18T09:31:46.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="è§£æ"><a href="#è§£æ" class="headerlink" title="è§£æ"></a><strong>è§£æ</strong></h2><p>handler æºç ä¹Ÿç®—æ˜¯è€ç”Ÿå¸¸è°ˆäº†ï¼Œä¹‹å‰ä¹Ÿç®€å•ç ”ç©¶è¿‡æºç ã€‚é¦–å…ˆåˆ—å‡ºæ¯”è¾ƒé‡è¦çš„å‡ ä¸ªç±»</p><ul><li><p>Handler</p></li><li><p>MessageQueue</p></li><li><p>Message</p></li><li><p>Looper</p></li></ul><p>é‚£ä¹ˆæˆ‘ä»¬å°±ä» Handler æœ€ç»å…¸çš„ç”¨æ³•å¼€å§‹åˆ†æ</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MainActivity</span> : <span class="type">AppCompatActivity</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> handler = <span class="keyword">object</span> : Handler(Looper.getMainLooper()) &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">handleMessage</span><span class="params">(msg: <span class="type">Message</span>)</span></span> &#123;</span><br><span class="line">            Toast.makeText(<span class="keyword">this</span><span class="symbol">@MainActivity</span>, <span class="string">&quot;å¤„ç†æ¶ˆæ¯&quot;</span>, Toast.LENGTH_SHORT).show()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">            setContentView(R.layout.activity_main)</span><br><span class="line">            handler.sendEmptyMessage(<span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±æœ‰ä¸¤ä¸ªå…¥å£å¯ä»¥åˆ†æ <code>Handler#sendMessage</code>, <code>Handler#handleMessage</code></p><h3 id="Handler-sendMessage"><a href="#Handler-sendMessage" class="headerlink" title="Handler#sendMessage"></a><strong>Handler#sendMessage</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…·ä½“å®ç°çœ‹sendMessageDelay</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">sendMessage</span><span class="params">(<span class="meta">@NonNull</span> Message msg)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> sendMessageDelayed(msg, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…·ä½“å®ç°çœ‹ sendMessageAtTime</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">sendMessageDelayed</span><span class="params">(<span class="meta">@NonNull</span> Message msg, <span class="type">long</span> delayMillis)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (delayMillis &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        delayMillis = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sendMessageAtTime(msg, SystemClock.uptimeMillis() + delayMillis);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‹¿åˆ°å­—æ®µé‡Œçš„ MessageQueueï¼Œç„¶å enqueueMessage</span></span><br><span class="line"><span class="comment">// è¿™ä¸ªåå­—å¾ˆå®¹æ˜“çŒœåˆ°è¿™æ˜¯æ¶ˆæ¯å…¥é˜Ÿçš„æ“ä½œ</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">sendMessageAtTime</span><span class="params">(<span class="meta">@NonNull</span> Message msg, <span class="type">long</span> uptimeMillis)</span> &#123;</span><br><span class="line">    <span class="type">MessageQueue</span> <span class="variable">queue</span> <span class="operator">=</span> mQueue;</span><br><span class="line">    <span class="keyword">if</span> (queue == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">RuntimeException</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">                <span class="built_in">this</span> + <span class="string">&quot; sendMessageAtTime() called with no mQueue&quot;</span>);</span><br><span class="line">        Log.w(<span class="string">&quot;Looper&quot;</span>, e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> enqueueMessage(queue, msg, uptimeMillis);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">enqueueMessage</span><span class="params">(<span class="meta">@NonNull</span> MessageQueue queue, <span class="meta">@NonNull</span> Message msg,</span></span><br><span class="line"><span class="params">        <span class="type">long</span> uptimeMillis)</span> &#123;</span><br><span class="line">    <span class="comment">// å°† msg çš„ target è®¾ç½®ä¸º handler è‡ªèº«ï¼Œæ–¹ä¾¿å‡ºé˜Ÿåæ‹¿åˆ°æ¶ˆæ¯çš„å‘é€è€…å›è°ƒ handleMessage</span></span><br><span class="line">    msg.target = <span class="built_in">this</span>;</span><br><span class="line">    <span class="comment">// è®¾ç½® workSourceUid</span></span><br><span class="line">    msg.workSourceUid = ThreadLocalWorkSource.getUid();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨new Handlerçš„æ—¶å€™å¯ä»¥è®¾ç½®ä¸ºå¼‚æ­¥ï¼Œè¿™æ ·è¿™ä¸ªhandlerå‘é€çš„æ¶ˆæ¯éƒ½æ˜¯å¼‚æ­¥æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">if</span> (mAsynchronous) &#123;</span><br><span class="line">        msg.setAsynchronous(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> queue.enqueueMessage(msg, uptimeMillis);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å°±è¿›å…¥äº† <code>MessageQueue#enqueueMessage</code></p><h3 id="MessageQueue-enqueueMessage"><a href="#MessageQueue-enqueueMessage" class="headerlink" title="MessageQueue#enqueueMessage"></a><strong>MessageQueue#enqueueMessage</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">enqueueMessage</span><span class="params">(Message msg, <span class="type">long</span> when)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (msg.target == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Message must have a target.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸Šé”ï¼Œä¿è¯æ²¡æœ‰ä¸¤æ¡æ¶ˆæ¯åŒæ—¶è¿›è¡Œå…¥é˜Ÿæ“ä½œäº§ç”Ÿå¹¶å‘é—®é¢˜</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœè¿™ä¸ª messgae æ­£åœ¨é˜Ÿåˆ—ä¸­ï¼Œå½“ç„¶ä¸èƒ½å†æ¬¡å…¥é˜Ÿ</span></span><br><span class="line">        <span class="comment">// è¯´ä¸€ç‚¹å°å°çš„æ„Ÿæ‚Ÿå§ï¼Œrustè¯­è¨€çš„ç§»åŠ¨è¯­ä¹‰å¯ä»¥è®©å¤šæ¬¡å…¥é˜Ÿæˆä¸ºä¸å¯èƒ½ï¼Œè€Œåœ¨javaä¸­ä¸ºäº†é˜²èŒƒè¿™ç§è¾¹ç•Œæƒ…å†µè¦å†™å¤§é‡çš„æ£€æŸ¥ä»£ç ã€‚ç§»åŠ¨è¯­ä¹‰è¿™ä¸ªè®¾è®¡ç¡®å®é«˜æ˜</span></span><br><span class="line">        <span class="keyword">if</span> (msg.isInUse()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(msg + <span class="string">&quot; This message is already in use.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœè¿™ä¸ªçº¿ç¨‹æ­£åœ¨é€€å‡ºï¼Œå½“ç„¶ä¸èƒ½ç»™ä¸€æ¡æ­»æ‰çš„çº¿ç¨‹ä¸Šçš„handlerå‘æ¶ˆæ¯</span></span><br><span class="line">        <span class="keyword">if</span> (mQuitting) &#123;</span><br><span class="line">            <span class="type">IllegalStateException</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">                    msg.target + <span class="string">&quot; sending message to a Handler on a dead thread&quot;</span>);</span><br><span class="line">            Log.w(TAG, e.getMessage(), e);</span><br><span class="line">            msg.recycle();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ ‡è®°è¿™ä¸ªæ¶ˆæ¯æ­£åœ¨ä½¿ç”¨</span></span><br><span class="line">        msg.markInUse();</span><br><span class="line">        <span class="comment">// è®¾ç½®è¿™æ¡ä¿¡æ¯åº”å½“ä»é˜Ÿåˆ—å–å‡ºæ—¶çš„æ—¶é—´</span></span><br><span class="line">        msg.when = when;</span><br><span class="line">        <span class="comment">// æ‹¿åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹ï¼Œæ²¡é”™ï¼Œæ¶ˆæ¯é˜Ÿåˆ—æ˜¯ä¸€ä¸ªé“¾è¡¨ç»“æ„</span></span><br><span class="line">        <span class="type">Message</span> <span class="variable">p</span> <span class="operator">=</span> mMessages;</span><br><span class="line">        <span class="type">boolean</span> needWake;</span><br><span class="line">        <span class="comment">// å¦‚æœå¤´èŠ‚ç‚¹ä¸ºç©º æˆ–è€… when == 0 ï¼ˆæ„å‘³ç€è¿™ä¸ªæ¶ˆæ¯å¿…é¡»æ”¾ç½®åœ¨å¤´èŠ‚ç‚¹ï¼‰æˆ–è€… æ–°æ’å…¥çš„æ¶ˆæ¯å‡ºé˜Ÿæ—¶é—´æ¯”å¤´èŠ‚ç‚¹æ—©</span></span><br><span class="line">        <span class="comment">// å°±å°†æ’å…¥çš„æ¶ˆæ¯è®¾ç½®ä¸ºæ–°çš„å¤´èŠ‚ç‚¹</span></span><br><span class="line">        <span class="comment">// è¿™é‡Œå¯ä»¥çœ‹å‡ºæ¶ˆæ¯é˜Ÿåˆ—æ˜¯ä¸€ä¸ªä¼˜å…ˆé˜Ÿåˆ—</span></span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">null</span> || when == <span class="number">0</span> || when &lt; p.when) &#123;</span><br><span class="line">            <span class="comment">// New head, wake up the event queue if blocked.</span></span><br><span class="line">            msg.next = p;</span><br><span class="line">            mMessages = msg;</span><br><span class="line">            <span class="comment">// å¦‚æœäº‹ä»¶é˜Ÿåˆ—ç°åœ¨æ­£å¤„äºç­‰å¾…çŠ¶æ€å°±ä¹‹åå”¤é†’ä»– ï¼ˆå…¶å®å°±æ˜¯å”¤é†’epollç­‰å¾…çš„äº‹ä»¶çº¿ç¨‹ï¼‰</span></span><br><span class="line">            needWake = mBlocked;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Inserted within the middle of the queue.  Usually we don&#x27;t have to wake</span></span><br><span class="line">            <span class="comment">// up the event queue unless there is a barrier at the head of the queue</span></span><br><span class="line">            <span class="comment">// and the message is the earliest asynchronous message in the queue.</span></span><br><span class="line">            <span class="comment">// åœ¨é˜Ÿåˆ—çš„ä¸­é—´æ’å…¥ã€‚é€šå¸¸æˆ‘ä»¬ä¸ä¼šå”¤é†’è¿™ä¸ªäº‹ä»¶é˜Ÿåˆ—é™¤éé˜Ÿåˆ—çš„å¤´éƒ¨æœ‰ä¸€ä¸ªåŒæ­¥å±éšœ</span></span><br><span class="line">            <span class="comment">// ä¸”è¿™æ¡æ¶ˆæ¯æ˜¯é˜Ÿåˆ—ä¸­æœ€æ—©çš„å¼‚æ­¥æ¶ˆæ¯</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ­£åœ¨é˜»å¡ ä¸” p.target == null ä¸” æ˜¯å¼‚æ­¥æ¶ˆæ¯</span></span><br><span class="line">            <span class="comment">// å¦‚æœ p.target == null åˆ™è¯´æ˜é˜Ÿåˆ—çš„å¤´éƒ¨æ˜¯ä¸€æ¡å±éšœæ¶ˆæ¯</span></span><br><span class="line">            needWake = mBlocked &amp;&amp; p.target == <span class="literal">null</span> &amp;&amp; msg.isAsynchronous();</span><br><span class="line">            <span class="comment">// ç»å…¸ç®—æ³•é¢˜ï¼ŒåŒæŒ‡é’ˆéå†é“¾è¡¨</span></span><br><span class="line">            Message prev;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                prev = p;</span><br><span class="line">                p = p.next;</span><br><span class="line">                <span class="comment">// éå†åˆ°å°¾éƒ¨æˆ–éå†åˆ°äº†è‡ªå·±åº”è¯¥å¾…çš„åœ°æ–¹ break å‡ºå»</span></span><br><span class="line">                <span class="keyword">if</span> (p == <span class="literal">null</span> || when &lt; p.when) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// å¦‚æœè§¦å‘è¿™ä¸€è¡Œï¼Œè¯´æ˜è¿™æ¡æ¶ˆæ¯ä¸æ˜¯æœ€æ—©çš„å¼‚æ­¥æ¶ˆæ¯ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦å”¤é†’äº†</span></span><br><span class="line">                <span class="keyword">if</span> (needWake &amp;&amp; p.isAsynchronous()) &#123;</span><br><span class="line">                    needWake = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ’å…¥</span></span><br><span class="line">            msg.next = p; <span class="comment">// invariant: p == prev.next</span></span><br><span class="line">            prev.next = msg;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We can assume mPtr != 0 because mQuitting is false.</span></span><br><span class="line">        <span class="comment">// å¦‚æœéœ€è¦å”¤é†’å°±è°ƒç”¨ nativeWake è¿›åˆ° native å±‚å¯¹äº‹ä»¶å¾ªç¯è¿›è¡Œå”¤é†’</span></span><br><span class="line">        <span class="keyword">if</span> (needWake) &#123;</span><br><span class="line">            nativeWake(mPtr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¿€åŠ¨äººå¿ƒçš„ native ä¹‹æ—…å°±è¦å¯ç¨‹å•¦ï½</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">nativeWake</span><span class="params">(<span class="type">long</span> ptr)</span>;</span><br></pre></td></tr></table></figure><h3 id="native-NativeMessageQueue-wake"><a href="#native-NativeMessageQueue-wake" class="headerlink" title="native NativeMessageQueue#wake"></a><strong>native NativeMessageQueue#wake</strong></h3><p>å‰å¾€ <a href="http://aospxref.com/">AOSPXRef</a> æŸ¥çœ‹æºç </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">android_os_MessageQueue_nativeWake</span><span class="params">(JNIEnv* env, jclass clazz, jlong ptr)</span> </span>&#123;</span><br><span class="line">    NativeMessageQueue* nativeMessageQueue = <span class="built_in">reinterpret_cast</span>&lt;NativeMessageQueue*&gt;(ptr);</span><br><span class="line">    nativeMessageQueue-&gt;<span class="built_in">wake</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">NativeMessageQueue::wake</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mLooper-&gt;<span class="built_in">wake</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹å‡º java å±‚ä¼ å…¥çš„ mPtr å…¶å®å°±æ˜¯ native å±‚çš„ MessageQueue çš„æŒ‡é’ˆã€‚å¹¶ä¸” wake æ–¹æ³•å®é™…ä¸Šæ˜¯è°ƒç”¨äº† <code>Looper#wake</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Looper::wake</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG_POLL_AND_WAKE</span></span><br><span class="line">    <span class="built_in">ALOGD</span>(<span class="string">&quot;%p ~ wake&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">uint64_t</span> inc = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// TEMP_FAILURE_RETRY è¿™ä¸ªå®ç”¨äºåœ¨ç³»ç»Ÿè°ƒç”¨å¤±è´¥æ—¶é‡è¯•</span></span><br><span class="line">    <span class="comment">// å¯¹ wakeEventFd è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦å†™å…¥å”¤é†’ä¿¡å· (1)ï¼Œepoll IO å¤šè·¯å¤ç”¨æœºåˆ¶ä¾¿ä¼šå”¤é†’çº¿ç¨‹</span></span><br><span class="line">    <span class="type">ssize_t</span> nWrite = <span class="built_in">TEMP_FAILURE_RETRY</span>(<span class="built_in">write</span>(mWakeEventFd.<span class="built_in">get</span>(), &amp;inc, <span class="built_in">sizeof</span>(<span class="type">uint64_t</span>)));</span><br><span class="line">    <span class="comment">// å†™å…¥å¤±è´¥å¯¹åº”çš„å¼‚å¸¸å¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> (nWrite != <span class="built_in">sizeof</span>(<span class="type">uint64_t</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (errno != EAGAIN) &#123;</span><br><span class="line">            <span class="built_in">LOG_ALWAYS_FATAL</span>(<span class="string">&quot;Could not write wake signal to fd %d (returned %zd): %s&quot;</span>, mWakeEventFd.<span class="built_in">get</span>(), nWrite, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å‘ mWakeEventFd å†™å…¥äº†å”¤é†’ä¿¡å·ï¼ŒLooper æ‰€å¯¹åº”çº¿ç¨‹ä¸Šçš„ epoll æœºåˆ¶ä¼šåœæ­¢ç­‰å¾…å”¤é†’ä¿¡å·ï¼Œå¯¹çº¿ç¨‹è¿›è¡Œå”¤é†’ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ epoll æ˜¯éœ€è¦äº‹å…ˆæ³¨å†Œæ–‡ä»¶æè¿°ç¬¦çš„ï¼Œæ‰¾å‡ºè¿™éƒ¨åˆ†ä»£ç ï¼Œæˆ‘ä»¬ç»§ç»­åˆ†æ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Looper::rebuildEpollLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Close old epoll instance if we have one.</span></span><br><span class="line">    <span class="keyword">if</span> (mEpollFd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG_CALLBACKS</span></span><br><span class="line">        <span class="built_in">ALOGD</span>(<span class="string">&quot;%p ~ rebuildEpollLocked - rebuilding epoll set&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        mEpollFd.<span class="built_in">reset</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allocate the new epoll instance and register the WakeEventFd.</span></span><br><span class="line">    <span class="comment">// åˆ†é…æ–°çš„ epoll instance å¹¶ä¸”æ³¨å†Œ WakeEventFd</span></span><br><span class="line">    mEpollFd.<span class="built_in">reset</span>(<span class="built_in">epoll_create1</span>(EPOLL_CLOEXEC));</span><br><span class="line">    <span class="built_in">LOG_ALWAYS_FATAL_IF</span>(mEpollFd &lt; <span class="number">0</span>, <span class="string">&quot;Could not create epoll instance: %s&quot;</span>, <span class="built_in">strerror</span>(errno));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»º epoll äº‹ä»¶ wakeEvent</span></span><br><span class="line">    epoll_event wakeEvent = <span class="built_in">createEpollEvent</span>(EPOLLIN, WAKE_EVENT_FD_SEQ);</span><br><span class="line">    <span class="comment">// æ³¨å†Œæ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">    <span class="type">int</span> result = <span class="built_in">epoll_ctl</span>(mEpollFd.<span class="built_in">get</span>(), EPOLL_CTL_ADD, mWakeEventFd.<span class="built_in">get</span>(), &amp;wakeEvent);</span><br><span class="line">    <span class="built_in">LOG_ALWAYS_FATAL_IF</span>(result != <span class="number">0</span>, <span class="string">&quot;Could not add wake event fd to epoll instance: %s&quot;</span>,</span><br><span class="line">            <span class="built_in">strerror</span>(errno));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨å†Œå…¶ä»– epoll äº‹ä»¶ï¼šæ¯”å¦‚å±å¹•è§¦æ‘¸äº‹ä»¶ï¼Œè§¦æ‘¸å±å¹•æ—¶éœ€è¦å”¤é†’çº¿ç¨‹å¹¶åœ¨ä¸»çº¿ç¨‹å›è°ƒ onTouch</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; [seq, request] : mRequests) &#123;</span><br><span class="line">        epoll_event eventItem = <span class="built_in">createEpollEvent</span>(request.<span class="built_in">getEpollEvents</span>(), seq);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> epollResult = <span class="built_in">epoll_ctl</span>(mEpollFd.<span class="built_in">get</span>(), EPOLL_CTL_ADD, request.fd, &amp;eventItem);</span><br><span class="line">        <span class="keyword">if</span> (epollResult &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">ALOGE</span>(<span class="string">&quot;Error adding epoll events for fd %d while rebuilding epoll set: %s&quot;</span>,</span><br><span class="line">                    request.fd, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨å†Œäº†ä¹‹åï¼Œé—®é¢˜æ˜¯åœ¨å“ªé‡Œè¿›è¡Œ <code>epoll_wait</code> ç­‰å¾…å‘¢ï¼Ÿåœ¨è¿™é‡Œå…ˆæŒ‰ä¸‹ä¸è¡¨ï¼Œæˆ‘ä»¬ä» <code>Handler#handleMessage</code> å¼€å§‹åˆ†æã€‚</p><h3 id="Handler-handleMessage"><a href="#Handler-handleMessage" class="headerlink" title="Handler#handleMessage"></a><strong>Handler#handleMessage</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Handler#dispatchMessage</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dispatchMessage</span><span class="params">(<span class="meta">@NonNull</span> Message msg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (msg.callback != <span class="literal">null</span>) &#123;</span><br><span class="line">        handleCallback(msg);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mCallback != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mCallback.handleMessage(msg)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        handleMessage(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Looper-loopOnce"><a href="#Looper-loopOnce" class="headerlink" title="Looper#loopOnce"></a><strong>Looper#loopOnce</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Looper#loopOnce</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">loopOnce</span><span class="params">(<span class="keyword">final</span> Looper me,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> <span class="type">long</span> ident, <span class="keyword">final</span> <span class="type">int</span> thresholdOverride)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡è¦æ­¥éª¤ï¼Œä»é˜Ÿåˆ—ä¸­å–å‡ºæ¶ˆæ¯</span></span><br><span class="line">    <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> me.mQueue.next(); <span class="comment">// might block</span></span><br><span class="line">    <span class="keyword">if</span> (msg == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// No message indicates that the message queue is quitting.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This must be in a local variable, in case a UI event sets the logger</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Printer</span> <span class="variable">logging</span> <span class="operator">=</span> me.mLogging;</span><br><span class="line">    <span class="keyword">if</span> (logging != <span class="literal">null</span>) &#123;</span><br><span class="line">        logging.println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt; Dispatching to &quot;</span> + msg.target + <span class="string">&quot; &quot;</span></span><br><span class="line">                + msg.callback + <span class="string">&quot;: &quot;</span> + msg.what);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Make sure the observer won&#x27;t change while processing a transaction.</span></span><br><span class="line">    <span class="comment">// è¿™ä¸ª Observer å¯ä»¥åœ¨æ¶ˆæ¯å¤„ç†å‰å’Œæ¶ˆæ¯å¤„ç†ååšä¸€äº›äº‹æƒ…</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Observer</span> <span class="variable">observer</span> <span class="operator">=</span> sObserver;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">traceTag</span> <span class="operator">=</span> me.mTraceTag;</span><br><span class="line">    <span class="type">long</span> <span class="variable">slowDispatchThresholdMs</span> <span class="operator">=</span> me.mSlowDispatchThresholdMs;</span><br><span class="line">    <span class="type">long</span> <span class="variable">slowDeliveryThresholdMs</span> <span class="operator">=</span> me.mSlowDeliveryThresholdMs;</span><br><span class="line">    <span class="keyword">if</span> (thresholdOverride &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        slowDispatchThresholdMs = thresholdOverride;</span><br><span class="line">        slowDeliveryThresholdMs = thresholdOverride;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">logSlowDelivery</span> <span class="operator">=</span> (slowDeliveryThresholdMs &gt; <span class="number">0</span>) &amp;&amp; (msg.when &gt; <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">logSlowDispatch</span> <span class="operator">=</span> (slowDispatchThresholdMs &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">needStartTime</span> <span class="operator">=</span> logSlowDelivery || logSlowDispatch;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">needEndTime</span> <span class="operator">=</span> logSlowDispatch;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (traceTag != <span class="number">0</span> &amp;&amp; Trace.isTagEnabled(traceTag)) &#123;</span><br><span class="line">        Trace.traceBegin(traceTag, msg.target.getTraceName(msg));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">dispatchStart</span> <span class="operator">=</span> needStartTime ? SystemClock.uptimeMillis() : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> dispatchEnd;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">token</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (observer != <span class="literal">null</span>) &#123;</span><br><span class="line">        token = observer.messageDispatchStarting();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="variable">origWorkSource</span> <span class="operator">=</span> ThreadLocalWorkSource.setUid(msg.workSourceUid);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// åœ¨è¿™é‡ŒæŠŠæ¶ˆæ¯å‘ç»™ Handler</span></span><br><span class="line">        msg.target.dispatchMessage(msg);</span><br><span class="line">        <span class="keyword">if</span> (observer != <span class="literal">null</span>) &#123;</span><br><span class="line">            observer.messageDispatched(token, msg);</span><br><span class="line">        &#125;</span><br><span class="line">        dispatchEnd = needEndTime ? SystemClock.uptimeMillis() : <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">        <span class="keyword">if</span> (observer != <span class="literal">null</span>) &#123;</span><br><span class="line">            observer.dispatchingThrewException(token, msg, exception);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> exception;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        ThreadLocalWorkSource.restore(origWorkSource);</span><br><span class="line">        <span class="keyword">if</span> (traceTag != <span class="number">0</span>) &#123;</span><br><span class="line">            Trace.traceEnd(traceTag);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (logSlowDelivery) &#123;</span><br><span class="line">        <span class="keyword">if</span> (me.mSlowDeliveryDetected) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((dispatchStart - msg.when) &lt;= <span class="number">10</span>) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">&quot;Drained&quot;</span>);</span><br><span class="line">                me.mSlowDeliveryDetected = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (showSlowLog(slowDeliveryThresholdMs, msg.when, dispatchStart, <span class="string">&quot;delivery&quot;</span>,</span><br><span class="line">                        msg)) &#123;</span><br><span class="line">                <span class="comment">// Once we write a slow delivery log, suppress until the queue drains.</span></span><br><span class="line">                me.mSlowDeliveryDetected = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (logSlowDispatch) &#123;</span><br><span class="line">        showSlowLog(slowDispatchThresholdMs, dispatchStart, dispatchEnd, <span class="string">&quot;dispatch&quot;</span>, msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (logging != <span class="literal">null</span>) &#123;</span><br><span class="line">        logging.println(<span class="string">&quot;&lt;&lt;&lt;&lt;&lt; Finished to &quot;</span> + msg.target + <span class="string">&quot; &quot;</span> + msg.callback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make sure that during the course of dispatching the</span></span><br><span class="line">    <span class="comment">// identity of the thread wasn&#x27;t corrupted.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">newIdent</span> <span class="operator">=</span> Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">if</span> (ident != newIdent) &#123;</span><br><span class="line">        Log.wtf(TAG, <span class="string">&quot;Thread identity changed from 0x&quot;</span></span><br><span class="line">                + Long.toHexString(ident) + <span class="string">&quot; to 0x&quot;</span></span><br><span class="line">                + Long.toHexString(newIdent) + <span class="string">&quot; while dispatching to &quot;</span></span><br><span class="line">                + msg.target.getClass().getName() + <span class="string">&quot; &quot;</span></span><br><span class="line">                + msg.callback + <span class="string">&quot; what=&quot;</span> + msg.what);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¶ˆæ¯å·²ç»ç”¨å®Œäº†ï¼Œæ¸…é™¤çŠ¶æ€æ”¾å…¥å®ä¾‹æ± </span></span><br><span class="line">    msg.recycleUnchecked();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ«çœ‹ä¸Šé¢ä¸€å¤§å †ä»£ç ï¼Œå…¶å®æ ¸å¿ƒé€»è¾‘å°±æ˜¯ <code>MessageQueue#next</code> å–å‡ºæ¶ˆæ¯å¹¶æŠŠå®ƒåˆ†å‘ç»™ <code>Handler</code>ã€‚å…¶ä»–çš„ä»£ç åŸºæœ¬ä¸Šå°±æ˜¯å•ä¸ªæ¶ˆæ¯å¤„ç†å¤ªæ…¢çš„è­¦å‘Šæœºåˆ¶ã€‚</p><h3 id="Looper-loop"><a href="#Looper-loop" class="headerlink" title="Looper#loop"></a><strong>Looper#loop</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Looper</span> <span class="variable">me</span> <span class="operator">=</span> myLooper();</span><br><span class="line">    <span class="keyword">if</span> (me == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;No Looper; Looper.prepare() wasn&#x27;t called on this thread.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (me.mInLoop) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">&quot;Loop again would have the queued messages be executed&quot;</span></span><br><span class="line">                + <span class="string">&quot; before this one completed.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    me.mInLoop = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make sure the identity of this thread is that of the local process,</span></span><br><span class="line">    <span class="comment">// and keep track of what that identity token actually is.</span></span><br><span class="line">    Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">ident</span> <span class="operator">=</span> Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allow overriding a threshold with a system prop. e.g.</span></span><br><span class="line">    <span class="comment">// adb shell &#x27;setprop log.looper.1000.main.slow 1 &amp;&amp; stop &amp;&amp; start&#x27;</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">thresholdOverride</span> <span class="operator">=</span></span><br><span class="line">        SystemProperties.getInt(<span class="string">&quot;log.looper.&quot;</span></span><br><span class="line">                + Process.myUid() + <span class="string">&quot;.&quot;</span></span><br><span class="line">                + Thread.currentThread().getName()</span><br><span class="line">                + <span class="string">&quot;.slow&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    me.mSlowDeliveryDetected = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!loopOnce(me, ident, thresholdOverride)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡è¦ä»£ç ä¹Ÿå°±æ˜¯æœ€åçš„æ­»å¾ªç¯ï¼Œè¿™ä¸ªæ­»å¾ªç¯åªä¼šåœ¨ MessageQueue æ­£åœ¨é€€å‡ºçš„æ—¶å€™è¿”å›ã€‚</p><h3 id="MessageQueue-next"><a href="#MessageQueue-next" class="headerlink" title="MessageQueue#next"></a><strong>MessageQueue#next</strong></h3><p>é‡å¤´æˆæ¥äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line">Message <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// Return here if the message loop has already quit and been disposed.</span></span><br><span class="line">    <span class="comment">// This can happen if the application tries to restart a looper after quit</span></span><br><span class="line">    <span class="comment">// which is not supported.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">ptr</span> <span class="operator">=</span> mPtr;</span><br><span class="line">    <span class="keyword">if</span> (ptr == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œå‡ºç°äº† IdleHandler çš„å­—çœ¼</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">pendingIdleHandlerCount</span> <span class="operator">=</span> -<span class="number">1</span>; <span class="comment">// -1 only during first iteration</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">nextPollTimeoutMillis</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nextPollTimeoutMillis != <span class="number">0</span>) &#123;</span><br><span class="line">            Binder.flushPendingCommands();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// pollOnce å…¶å®å°±æ˜¯ä¸€ä¸ªè®¾ç½®äº†è¶…æ—¶æ—¶é—´çš„ epoll_wait</span></span><br><span class="line">        nativePollOnce(ptr, nextPollTimeoutMillis);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="comment">// Try to retrieve the next message.  Return if found.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> SystemClock.uptimeMillis();</span><br><span class="line">            <span class="type">Message</span> <span class="variable">prevMsg</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> mMessages;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ¶ˆæ¯é˜Ÿåˆ—çš„å¤´éƒ¨æœ‰åŒæ­¥å±éšœ</span></span><br><span class="line">            <span class="keyword">if</span> (msg != <span class="literal">null</span> &amp;&amp; msg.target == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Stalled by a barrier.  Find the next asynchronous message in the queue.</span></span><br><span class="line">                <span class="comment">// æ‰¾å‡ºé˜Ÿåˆ—ä¸­çš„é¦–ä¸ªå¼‚æ­¥æ¶ˆæ¯</span></span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    prevMsg = msg;</span><br><span class="line">                    msg = msg.next;</span><br><span class="line">                &#125; <span class="keyword">while</span> (msg != <span class="literal">null</span> &amp;&amp; !msg.isAsynchronous());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœæœ‰æ¶ˆæ¯</span></span><br><span class="line">            <span class="keyword">if</span> (msg != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// è¿™ä¸ªæ¶ˆæ¯è¿˜æ²¡æœ‰åˆ°æ—¶é—´ï¼Œè®¾ç½®ä¸€ä¸‹ä¸‹è½®å¾ªç¯æ‰§è¡Œçš„ pollOnce çš„è¶…æ—¶æ—¶é—´</span></span><br><span class="line">                <span class="keyword">if</span> (now &lt; msg.when) &#123;</span><br><span class="line">                    <span class="comment">// Next message is not ready.  Set a timeout to wake up when it is ready.</span></span><br><span class="line">                    nextPollTimeoutMillis = (<span class="type">int</span>) Math.min(msg.when - now, Integer.MAX_VALUE);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// è¿™ä¸ªæ¶ˆæ¯å·²ç»åˆ°æ—¶é—´äº†ï¼Œä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºè¿”å›</span></span><br><span class="line">                    <span class="comment">// Got a message.</span></span><br><span class="line">                    mBlocked = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">if</span> (prevMsg != <span class="literal">null</span>) &#123;</span><br><span class="line">                        prevMsg.next = msg.next;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        mMessages = msg.next;</span><br><span class="line">                    &#125;</span><br><span class="line">                    msg.next = <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">&quot;Returning message: &quot;</span> + msg);</span><br><span class="line">                    msg.markInUse();</span><br><span class="line">                    <span class="keyword">return</span> msg;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// é˜Ÿåˆ—ç©ºäº†ï¼Œè¿›å…¥æ— é™æœŸçš„ epoll_wait ç­‰å¾…</span></span><br><span class="line">                <span class="comment">// No more messages.</span></span><br><span class="line">                nextPollTimeoutMillis = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Process the quit message now that all pending messages have been handled.</span></span><br><span class="line">            <span class="keyword">if</span> (mQuitting) &#123;</span><br><span class="line">                dispose();</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è¿™é‡Œæ˜¯ IdleHandler ç›¸å…³çš„å†…å®¹ï¼Œå…ˆå»çœ‹çœ‹ IdleHandler è¿™ä¸ªä¸œè¥¿æ€ä¹ˆç”¨</span></span><br><span class="line">            <span class="comment">// If first time idle, then get the number of idlers to run.</span></span><br><span class="line">            <span class="comment">// Idle handles only run if the queue is empty or if the first message</span></span><br><span class="line">            <span class="comment">// in the queue (possibly a barrier) is due to be handled in the future.</span></span><br><span class="line">            <span class="comment">// ç¬¬ä¸€æ¬¡ç©ºé—²çš„æ—¶å€™ï¼Œè®°å½•è¦è¿è¡Œçš„ idlehandler çš„æ•°é‡ã€‚</span></span><br><span class="line">            <span class="comment">// ç©ºé—²å¤„ç†åªåœ¨é˜Ÿåˆ—ä¸ºç©ºæˆ–ç¬¬ä¸€æ¡æ¶ˆæ¯éœ€è¦ç­‰å¾…ä¸€æ®µæ—¶é—´çš„æ—¶å€™æ‰§è¡Œ</span></span><br><span class="line">            <span class="comment">// è¯´ç™½äº†å°±æ˜¯åœ¨ pollOnce ä¹‹å‰æ‰§è¡Œ</span></span><br><span class="line">            <span class="keyword">if</span> (pendingIdleHandlerCount &lt; <span class="number">0</span></span><br><span class="line">                    &amp;&amp; (mMessages == <span class="literal">null</span> || now &lt; mMessages.when)) &#123;</span><br><span class="line">                pendingIdleHandlerCount = mIdleHandlers.size();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (pendingIdleHandlerCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// æ²¡æœ‰ IdleHandler çš„æƒ…å†µä¸‹å•æ¬¡å¾ªç¯åœ¨è¿™é‡Œç»“æŸ</span></span><br><span class="line">                <span class="comment">// No idle handlers to run.  Loop and wait some more.</span></span><br><span class="line">                mBlocked = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æœ€å¤§åªä¼šæ‰§è¡Œ4ä¸ª IdleHandler</span></span><br><span class="line">            <span class="keyword">if</span> (mPendingIdleHandlers == <span class="literal">null</span>) &#123;</span><br><span class="line">                mPendingIdleHandlers = <span class="keyword">new</span> <span class="title class_">IdleHandler</span>[Math.max(pendingIdleHandlerCount, <span class="number">4</span>)];</span><br><span class="line">            &#125;</span><br><span class="line">            mPendingIdleHandlers = mIdleHandlers.toArray(mPendingIdleHandlers);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Run the idle handlers.</span></span><br><span class="line">        <span class="comment">// We only ever reach this code block during the first iteration.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; pendingIdleHandlerCount; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">IdleHandler</span> <span class="variable">idler</span> <span class="operator">=</span> mPendingIdleHandlers[i];</span><br><span class="line">            mPendingIdleHandlers[i] = <span class="literal">null</span>; <span class="comment">// release the reference to the handler</span></span><br><span class="line"></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">keep</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">// æ‰§è¡Œ</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                keep = idler.queueIdle();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                Log.wtf(TAG, <span class="string">&quot;IdleHandler threw exception&quot;</span>, t);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ä¸ä¿ç•™å°±åˆ æ‰</span></span><br><span class="line">            <span class="keyword">if</span> (!keep) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                    mIdleHandlers.remove(idler);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é‡åˆ¶æ•°é‡</span></span><br><span class="line">        <span class="comment">// Reset the idle handler count to 0 so we do not run them again.</span></span><br><span class="line">        pendingIdleHandlerCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‰§è¡Œäº†idleHandlerå°±ä¸ç­‰å¾…äº†ï¼Œå› ä¸ºå¯èƒ½åœ¨idleHandlerä¸­å·²ç»å‘é€äº†æ–°çš„æ¶ˆæ¯ï¼Œé‡èµ°ä¸€éæµç¨‹</span></span><br><span class="line">        <span class="comment">// While calling an idle handler, a new message could have been delivered</span></span><br><span class="line">        <span class="comment">// so go back and look again for a pending message without waiting.</span></span><br><span class="line">        nextPollTimeoutMillis = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="native-Looper-pollOnce"><a href="#native-Looper-pollOnce" class="headerlink" title="native Looper#pollOnce"></a><strong>native Looper#pollOnce</strong></h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">Looper::pollOnce</span><span class="params">(<span class="type">int</span> timeoutMillis, <span class="type">int</span>* outFd, <span class="type">int</span>* outEvents, <span class="type">void</span>** outData)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">while</span> (mResponseIndex &lt; mResponses.<span class="built_in">size</span>()) &#123;</span><br><span class="line">            <span class="type">const</span> Response&amp; response = mResponses.<span class="built_in">itemAt</span>(mResponseIndex++);</span><br><span class="line">            <span class="type">int</span> ident = response.request.ident;</span><br><span class="line">            <span class="keyword">if</span> (ident &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">int</span> fd = response.request.fd;</span><br><span class="line">                <span class="type">int</span> events = response.events;</span><br><span class="line">                <span class="type">void</span>* data = response.request.data;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG_POLL_AND_WAKE</span></span><br><span class="line">                <span class="built_in">ALOGD</span>(<span class="string">&quot;%p ~ pollOnce - returning signalled identifier %d: &quot;</span></span><br><span class="line">                        <span class="string">&quot;fd=%d, events=0x%x, data=%p&quot;</span>,</span><br><span class="line">                        <span class="keyword">this</span>, ident, fd, events, data);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                <span class="keyword">if</span> (outFd != <span class="literal">nullptr</span>) *outFd = fd;</span><br><span class="line">                <span class="keyword">if</span> (outEvents != <span class="literal">nullptr</span>) *outEvents = events;</span><br><span class="line">                <span class="keyword">if</span> (outData != <span class="literal">nullptr</span>) *outData = data;</span><br><span class="line">                <span class="keyword">return</span> ident;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// result != 0 æ—¶å¯ä»¥é€€å‡º</span></span><br><span class="line">        <span class="keyword">if</span> (result != <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG_POLL_AND_WAKE</span></span><br><span class="line">            <span class="built_in">ALOGD</span>(<span class="string">&quot;%p ~ pollOnce - returning result %d&quot;</span>, <span class="keyword">this</span>, result);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            <span class="keyword">if</span> (outFd != <span class="literal">nullptr</span>) *outFd = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (outEvents != <span class="literal">nullptr</span>) *outEvents = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (outData != <span class="literal">nullptr</span>) *outData = <span class="literal">nullptr</span>;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿™é‡Œå¦‚æœè¿”å›0çš„è¯å°±è¦ä¸€ç›´è·‘è¿™ä¸ªæ–¹æ³•ï¼Œä¸è¿‡æˆ‘ä»¬çŸ¥é“pollInnerå®é™…ä¸Šæ˜¯ä¸ä¼šè¿”å›çš„ (epoll_wait)</span></span><br><span class="line">        <span class="comment">// æ‰€ä»¥åœ¨è¿™é‡ŒçŒœæµ‹æ­£å¸¸æƒ…å†µä¸‹è¿”å›å°±é€€å‡ºå¾ªç¯ï¼Œåªæœ‰åœ¨æŸäº›æƒ…å†µä¸‹éœ€è¦é‡è¯•?</span></span><br><span class="line">        result = <span class="built_in">pollInner</span>(timeoutMillis);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥çœ‹çœ‹ pollInnerï¼Œä¸œè¥¿çœŸå¤šï¼Œæˆ‘ä»¬åªå…³æ³¨é‡ç‚¹ä»£ç </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">Looper::pollInner</span><span class="params">(<span class="type">int</span> timeoutMillis)</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG_POLL_AND_WAKE</span></span><br><span class="line">    <span class="built_in">ALOGD</span>(<span class="string">&quot;%p ~ pollOnce - waiting: timeoutMillis=%d&quot;</span>, <span class="keyword">this</span>, timeoutMillis);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Adjust the timeout based on when the next message is due.</span></span><br><span class="line">    <span class="keyword">if</span> (timeoutMillis != <span class="number">0</span> &amp;&amp; mNextMessageUptime != LLONG_MAX) &#123;</span><br><span class="line">        <span class="type">nsecs_t</span> now = <span class="built_in">systemTime</span>(SYSTEM_TIME_MONOTONIC);</span><br><span class="line">        <span class="type">int</span> messageTimeoutMillis = <span class="built_in">toMillisecondTimeoutDelay</span>(now, mNextMessageUptime);</span><br><span class="line">        <span class="keyword">if</span> (messageTimeoutMillis &gt;= <span class="number">0</span></span><br><span class="line">                &amp;&amp; (timeoutMillis &lt; <span class="number">0</span> || messageTimeoutMillis &lt; timeoutMillis)) &#123;</span><br><span class="line">            timeoutMillis = messageTimeoutMillis;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG_POLL_AND_WAKE</span></span><br><span class="line">        <span class="built_in">ALOGD</span>(<span class="string">&quot;%p ~ pollOnce - next message in %&quot;</span> PRId64 <span class="string">&quot;ns, adjusted timeout: timeoutMillis=%d&quot;</span>,</span><br><span class="line">                <span class="keyword">this</span>, mNextMessageUptime - now, timeoutMillis);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Poll.</span></span><br><span class="line">    <span class="comment">// resultçš„å–å€¼æœ‰å››ç§: POLL_WAKE = -1 POLL_CALLBACK = -2 POLL_TIMEOUT = -3 POLL_ERROR = -4</span></span><br><span class="line">    <span class="type">int</span> result = POLL_WAKE;</span><br><span class="line">    mResponses.<span class="built_in">clear</span>();</span><br><span class="line">    mResponseIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We are about to idle.</span></span><br><span class="line">    mPolling = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºäº‹ä»¶é›†åˆeventItemsï¼ŒEPOLL_MAX_EVENTS=16</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> eventItems[EPOLL_MAX_EVENTS];</span><br><span class="line">    <span class="comment">// è°ƒç”¨epoll_wait()æ¥ç­‰å¾…äº‹ä»¶ï¼Œå¦‚æœæœ‰äº‹ä»¶ï¼Œå°±æ”¾å…¥äº‹ä»¶é›†åˆeventItemsä¸­ï¼Œå¹¶è¿”å›äº‹ä»¶æ•°é‡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±ä¸€ç›´ç­‰ï¼Œè¶…æ—¶æ—¶é—´ä¸ºæˆ‘ä»¬ä¼ å…¥çš„timeoutMillis</span></span><br><span class="line">    <span class="type">int</span> eventCount = <span class="built_in">epoll_wait</span>(mEpollFd.<span class="built_in">get</span>(), eventItems, EPOLL_MAX_EVENTS, timeoutMillis);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// No longer idling.</span></span><br><span class="line">    mPolling = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Acquire lock.</span></span><br><span class="line">    <span class="comment">// åŠ é”</span></span><br><span class="line">    mLock.<span class="built_in">lock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Rebuild epoll set if needed.</span></span><br><span class="line">    <span class="keyword">if</span> (mEpollRebuildRequired) &#123;</span><br><span class="line">        mEpollRebuildRequired = <span class="literal">false</span>;</span><br><span class="line">        <span class="built_in">rebuildEpollLocked</span>();</span><br><span class="line">        <span class="keyword">goto</span> Done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check for poll error.</span></span><br><span class="line">    <span class="comment">// å¦‚æœå‘ç”Ÿçš„äº‹ä»¶å°äº0ï¼Œè¯´æ˜ epoll_wait å‡ºå¼‚å¸¸äº†ï¼Œè®¾ç½® result ä¸º POLL_ERROR åè·³è½¬åˆ° Done</span></span><br><span class="line">    <span class="keyword">if</span> (eventCount &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (errno == EINTR) &#123;</span><br><span class="line">            <span class="keyword">goto</span> Done;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">ALOGW</span>(<span class="string">&quot;Poll failed with an unexpected error: %s&quot;</span>, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        result = POLL_ERROR;</span><br><span class="line">        <span class="keyword">goto</span> Done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check for poll timeout.</span></span><br><span class="line">    <span class="comment">// epoll_wait è¶…æ—¶è¿”å›ï¼Œè·³è½¬åˆ° Done</span></span><br><span class="line">    <span class="keyword">if</span> (eventCount == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG_POLL_AND_WAKE</span></span><br><span class="line">        <span class="built_in">ALOGD</span>(<span class="string">&quot;%p ~ pollOnce - timeout&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        result = POLL_TIMEOUT;</span><br><span class="line">        <span class="keyword">goto</span> Done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handle all events.</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG_POLL_AND_WAKE</span></span><br><span class="line">    <span class="built_in">ALOGD</span>(<span class="string">&quot;%p ~ pollOnce - handling events from %d fds&quot;</span>, <span class="keyword">this</span>, eventCount);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// èµ°åˆ°è¿™é‡Œè¯´æ˜æœ‰äº‹ä»¶</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; eventCount; i++) &#123;</span><br><span class="line">        <span class="comment">// æŒ¨ä¸ªå–å‡ºäº‹ä»¶è¿›è¡Œå“åº”</span></span><br><span class="line">        <span class="type">const</span> SequenceNumber seq = eventItems[i].data.u64;</span><br><span class="line">        <span class="type">uint32_t</span> epollEvents = eventItems[i].events;</span><br><span class="line">        <span class="comment">// æ˜¯ wake event</span></span><br><span class="line">        <span class="keyword">if</span> (seq == WAKE_EVENT_FD_SEQ) &#123;</span><br><span class="line">            <span class="keyword">if</span> (epollEvents &amp; EPOLLIN) &#123;</span><br><span class="line">                <span class="comment">// æ¸…é™¤ wakeEventFd çš„äº‹ä»¶å¾ªç¯è®¡æ•°å™¨ï¼Œä»¥ä¾¿æ¥æ”¶ä¸‹ä¸€æ¬¡äº‹ä»¶</span></span><br><span class="line">                <span class="comment">// äº‹ä»¶æ–‡ä»¶æè¿°ç¬¦ï¼ˆå¦‚ eventfdï¼‰è¢«è®¾ç½®ä¸ºè¾¹ç¼˜è§¦å‘ï¼ˆETï¼‰æ¨¡å¼ã€‚</span></span><br><span class="line">                <span class="comment">// è¿™æ„å‘³ç€åªæœ‰åœ¨çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œepoll æ‰ä¼šè¿”å›è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„äº‹ä»¶ã€‚</span></span><br><span class="line">                <span class="comment">// å¦‚æœä½ ä¸è¯»å–è¿™ä¸ªäº‹ä»¶ï¼ŒçŠ¶æ€å°±ä¸ä¼šæ”¹å˜ï¼Œæ‰€ä»¥ epoll å¯èƒ½ä¸ä¼šå†æ¬¡è¿”å›è¿™ä¸ªäº‹ä»¶ï¼Œå³ä½¿æœ‰æ–°çš„å”¤é†’äº‹ä»¶å‘ç”Ÿã€‚</span></span><br><span class="line">                <span class="built_in">awoken</span>();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">ALOGW</span>(<span class="string">&quot;Ignoring unexpected epoll events 0x%x on wake event fd.&quot;</span>, epollEvents);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å“åº”å…¶ä»–äº‹ä»¶</span></span><br><span class="line">            <span class="type">const</span> <span class="keyword">auto</span>&amp; request_it = mRequests.<span class="built_in">find</span>(seq);</span><br><span class="line">            <span class="keyword">if</span> (request_it != mRequests.<span class="built_in">end</span>()) &#123;</span><br><span class="line">                <span class="type">const</span> <span class="keyword">auto</span>&amp; request = request_it-&gt;second;</span><br><span class="line">                <span class="type">int</span> events = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (epollEvents &amp; EPOLLIN) events |= EVENT_INPUT;</span><br><span class="line">                <span class="keyword">if</span> (epollEvents &amp; EPOLLOUT) events |= EVENT_OUTPUT;</span><br><span class="line">                <span class="keyword">if</span> (epollEvents &amp; EPOLLERR) events |= EVENT_ERROR;</span><br><span class="line">                <span class="keyword">if</span> (epollEvents &amp; EPOLLHUP) events |= EVENT_HANGUP;</span><br><span class="line">                mResponses.<span class="built_in">push</span>(&#123;.seq = seq, .events = events, .request = request&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">ALOGW</span>(<span class="string">&quot;Ignoring unexpected epoll events 0x%x for sequence number %&quot;</span> PRIu64</span><br><span class="line">                        <span class="string">&quot; that is no longer registered.&quot;</span>,</span><br><span class="line">                        epollEvents, seq);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">Done: ;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Invoke pending message callbacks.</span></span><br><span class="line">      <span class="comment">// è¿™é‡Œå°±æ˜¯å¤„ç† native å±‚çš„æ¶ˆæ¯ï¼Œè·Ÿ java å±‚ handler çš„é€»è¾‘å·®ä¸å¤š</span></span><br><span class="line">      <span class="comment">// native å±‚çš„æ¶ˆæ¯æ˜¯ç”¨ vector å­˜çš„</span></span><br><span class="line">      mNextMessageUptime = LLONG_MAX;</span><br><span class="line">      <span class="keyword">while</span> (mMessageEnvelopes.<span class="built_in">size</span>() != <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="type">nsecs_t</span> now = <span class="built_in">systemTime</span>(SYSTEM_TIME_MONOTONIC);</span><br><span class="line">          <span class="type">const</span> MessageEnvelope&amp; messageEnvelope = mMessageEnvelopes.<span class="built_in">itemAt</span>(<span class="number">0</span>);</span><br><span class="line">          <span class="comment">// æ¶ˆæ¯åˆ°æœŸ</span></span><br><span class="line">          <span class="keyword">if</span> (messageEnvelope.uptime &lt;= now) &#123;</span><br><span class="line">              <span class="comment">// Remove the envelope from the list.</span></span><br><span class="line">              <span class="comment">// We keep a strong reference to the handler until the call to handleMessage</span></span><br><span class="line">              <span class="comment">// finishes.  Then we drop it so that the handler can be deleted *before*</span></span><br><span class="line">              <span class="comment">// we reacquire our lock.</span></span><br><span class="line">              &#123; <span class="comment">// obtain handler</span></span><br><span class="line">                  sp&lt;MessageHandler&gt; handler = messageEnvelope.handler;</span><br><span class="line">                  Message message = messageEnvelope.message;</span><br><span class="line">                  mMessageEnvelopes.<span class="built_in">removeAt</span>(<span class="number">0</span>);</span><br><span class="line">                  mSendingMessage = <span class="literal">true</span>;</span><br><span class="line">                  mLock.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG_POLL_AND_WAKE || DEBUG_CALLBACKS</span></span><br><span class="line">                  <span class="built_in">ALOGD</span>(<span class="string">&quot;%p ~ pollOnce - sending message: handler=%p, what=%d&quot;</span>,</span><br><span class="line">                          <span class="keyword">this</span>, handler.<span class="built_in">get</span>(), message.what);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                  <span class="comment">// å›è°ƒ native å±‚ handler çš„ handleMessage</span></span><br><span class="line">                  handler-&gt;<span class="built_in">handleMessage</span>(message);</span><br><span class="line">              &#125; <span class="comment">// release handler</span></span><br><span class="line"></span><br><span class="line">              mLock.<span class="built_in">lock</span>();</span><br><span class="line">              mSendingMessage = <span class="literal">false</span>;</span><br><span class="line">              <span class="comment">// è¿™é‡Œ result å°±æ˜¯æŠŠmessageå›è°ƒç»™äº†handler</span></span><br><span class="line">              result = POLL_CALLBACK;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">// The last message left at the head of the queue determines the next wakeup time.</span></span><br><span class="line">              <span class="comment">// è®¾ç½®ä¸‹æ¡æ¶ˆæ¯åˆ°æœŸçš„æ—¶é—´ å¹¶è·³å‡ºå¾ªç¯ç­‰å¾…Javaå±‚çš„ä¸‹ä¸€æ¬¡è½®è¯¢</span></span><br><span class="line">              mNextMessageUptime = messageEnvelope.uptime;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Release lock.</span></span><br><span class="line">      mLock.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Invoke all response callbacks.</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; mResponses.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">          Response&amp; response = mResponses.<span class="built_in">editItemAt</span>(i);</span><br><span class="line">          <span class="keyword">if</span> (response.request.ident == POLL_CALLBACK) &#123;</span><br><span class="line">              <span class="type">int</span> fd = response.request.fd;</span><br><span class="line">              <span class="type">int</span> events = response.events;</span><br><span class="line">              <span class="type">void</span>* data = response.request.data;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG_POLL_AND_WAKE || DEBUG_CALLBACKS</span></span><br><span class="line">              <span class="built_in">ALOGD</span>(<span class="string">&quot;%p ~ pollOnce - invoking fd event callback %p: fd=%d, events=0x%x, data=%p&quot;</span>,</span><br><span class="line">                      <span class="keyword">this</span>, response.request.callback.<span class="built_in">get</span>(), fd, events, data);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">              <span class="comment">// Invoke the callback.  Note that the file descriptor may be closed by</span></span><br><span class="line">              <span class="comment">// the callback (and potentially even reused) before the function returns so</span></span><br><span class="line">              <span class="comment">// we need to be a little careful when removing the file descriptor afterwards.</span></span><br><span class="line">              <span class="type">int</span> callbackResult = response.request.callback-&gt;<span class="built_in">handleEvent</span>(fd, events, data);</span><br><span class="line">              <span class="keyword">if</span> (callbackResult == <span class="number">0</span>) &#123;</span><br><span class="line">                  AutoMutex _l(mLock);</span><br><span class="line">                  <span class="built_in">removeSequenceNumberLocked</span>(response.seq);</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="comment">// Clear the callback reference in the response structure promptly because we</span></span><br><span class="line">              <span class="comment">// will not clear the response vector itself until the next poll.</span></span><br><span class="line">              response.request.callback.<span class="built_in">clear</span>();</span><br><span class="line">              result = POLL_CALLBACK;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€»ä½“æµç¨‹å…¶å®å°±æ˜¯ epoll_wait æ‹¿åˆ°äº‹ä»¶ï¼Œå¤„ç†äº‹ä»¶å¹¶è®© native å±‚çš„æ¶ˆæ¯é˜Ÿåˆ—å–ä¸€æ¬¡æ¶ˆæ¯ã€‚</p><h2 id="é¢è¯•é¢˜"><a href="#é¢è¯•é¢˜" class="headerlink" title="é¢è¯•é¢˜"></a><strong>é¢è¯•é¢˜</strong></h2><blockquote><p>æ¥è‡ªè”·ç¥</p></blockquote><h3 id="handlerå¤§è‡´è¿è½¬è¿‡ç¨‹"><a href="#handlerå¤§è‡´è¿è½¬è¿‡ç¨‹" class="headerlink" title="handlerå¤§è‡´è¿è½¬è¿‡ç¨‹"></a><strong>handlerå¤§è‡´è¿è½¬è¿‡ç¨‹</strong></h3><p><code>Handler#sendMessage</code> -&gt; <code>MessageQueue#enqueueMessage</code> æ¶ˆæ¯å…¥é˜Ÿ -&gt; å¦‚æœæ¶ˆæ¯å…¥é˜Ÿæ—¶å¤„äºå¤´éƒ¨ï¼Œæˆ–å¤´éƒ¨æœ‰åŒæ­¥å±éšœä¸”æ’å…¥çš„æ¶ˆæ¯ä¸ºæœ€æ—©çš„å¼‚æ­¥æ¶ˆæ¯åˆ™å”¤é†’ Looper <code>NativeMessageQueue#wake</code></p><p>Looper è¢«å”¤é†’åè½®è¯¢å–æ¶ˆæ¯ï¼Œå–åˆ°æ¶ˆæ¯åçœ‹æ¶ˆæ¯æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœæ²¡æœ‰è¿‡æœŸå°± pollOnce ç­‰å¾…è‡³è¿‡æœŸï¼Œè¿‡æœŸäº†å°±å‡ºé˜Ÿå‘ç»™ Handlerï¼Œç›´åˆ°æ²¡æœ‰æ›´å¤šæ¶ˆæ¯æ—¶ pollOnce çš„è¿‡æœŸæ—¶é—´è¢«è®¾ç½®ä¸º -1ï¼Œæ— é™æœŸç­‰å¾…ç›´åˆ°æœ‰æ–°æ¶ˆæ¯æ’å…¥ã€‚</p><h3 id="handleræ¶ˆæ¯ç±»å‹ä»¥åŠæ¯ä¸ªç±»å‹çš„åŒºåˆ«"><a href="#handleræ¶ˆæ¯ç±»å‹ä»¥åŠæ¯ä¸ªç±»å‹çš„åŒºåˆ«" class="headerlink" title="handleræ¶ˆæ¯ç±»å‹ä»¥åŠæ¯ä¸ªç±»å‹çš„åŒºåˆ«"></a><strong>handleræ¶ˆæ¯ç±»å‹ä»¥åŠæ¯ä¸ªç±»å‹çš„åŒºåˆ«</strong></h3><p>åŒæ­¥æ¶ˆæ¯ï¼Œå¼‚æ­¥æ¶ˆæ¯ï¼ŒåŒæ­¥å±éšœ</p><h3 id="åŒæ­¥æ¶ˆæ¯å±éšœçš„æ„ä¹‰æ˜¯ä»€ä¹ˆ-é€šå¸¸ç”¨æ¥å¹²å˜›"><a href="#åŒæ­¥æ¶ˆæ¯å±éšœçš„æ„ä¹‰æ˜¯ä»€ä¹ˆ-é€šå¸¸ç”¨æ¥å¹²å˜›" class="headerlink" title="åŒæ­¥æ¶ˆæ¯å±éšœçš„æ„ä¹‰æ˜¯ä»€ä¹ˆ? é€šå¸¸ç”¨æ¥å¹²å˜›?"></a><strong>åŒæ­¥æ¶ˆæ¯å±éšœçš„æ„ä¹‰æ˜¯ä»€ä¹ˆ? é€šå¸¸ç”¨æ¥å¹²å˜›?</strong></h3><p>å…¶å®æ¯”è¾ƒç±»ä¼¼ä¸€äº›å¼‚æ­¥ä»»åŠ¡è°ƒåº¦æœºåˆ¶çš„ä»»åŠ¡å·å–ï¼ˆå¥½åƒå†…æ ¸æ€çš„ä»»åŠ¡è°ƒåº¦ä¹Ÿæœ‰å·å–è¿™ä¸ªæœºåˆ¶ï¼Ÿï¼‰</p><p>åœ¨æ¶ˆæ¯è¿‡å¤šå¤„ç†ä¸è¿‡æ¥çš„æƒ…å†µä¸‹ä¼˜å…ˆå¤„ç†å¼‚æ­¥æ¶ˆæ¯ï¼Œå¼‚æ­¥æ¶ˆæ¯çš„å¼‚æ­¥å…¶å®æŒ‡çš„å°±æ˜¯ä¸æŒ‰æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¶ˆæ¯çš„é¡ºåºæ‰§è¡Œï¼ˆæ¯•ç«Ÿåœ¨é‡åˆ°å±éšœçš„æ—¶å€™åªå¤„ç†å¼‚æ­¥äº‹ä»¶ï¼Œä¸å¤„ç†åŒæ­¥äº‹ä»¶ï¼‰</p><p>åŒæ­¥å±éšœç”¨å®Œè¦è®°å¾—æ’¤é”€ï¼Œä¸ç„¶å°±å†ä¹Ÿæ¥æ”¶ä¸åˆ°åŒæ­¥æ¶ˆæ¯äº†</p><h3 id="å¦‚æœæˆ‘è¦å‘é€handleræ¶ˆæ¯ï¼Œæ˜¯ç›´æ¥newå˜›-ä¸ºä»€ä¹ˆä¸è¿™æ ·ï¼Ÿè¿™æ ·ä¼šé€ æˆä»€ä¹ˆå½±å“"><a href="#å¦‚æœæˆ‘è¦å‘é€handleræ¶ˆæ¯ï¼Œæ˜¯ç›´æ¥newå˜›-ä¸ºä»€ä¹ˆä¸è¿™æ ·ï¼Ÿè¿™æ ·ä¼šé€ æˆä»€ä¹ˆå½±å“" class="headerlink" title="å¦‚æœæˆ‘è¦å‘é€handleræ¶ˆæ¯ï¼Œæ˜¯ç›´æ¥newå˜›? ä¸ºä»€ä¹ˆä¸è¿™æ ·ï¼Ÿè¿™æ ·ä¼šé€ æˆä»€ä¹ˆå½±å“?"></a><strong>å¦‚æœæˆ‘è¦å‘é€handleræ¶ˆæ¯ï¼Œæ˜¯ç›´æ¥newå˜›? ä¸ºä»€ä¹ˆä¸è¿™æ ·ï¼Ÿè¿™æ ·ä¼šé€ æˆä»€ä¹ˆå½±å“?</strong></h3><p>é‚£è‚¯å®šä¸newï¼Œä½¿ç”¨ <code>Message.obtain</code> ä»å¯¹è±¡æ± ä¸­æ‹¿å–ã€‚å¦‚æœå‘é€æ¶ˆæ¯éƒ½ç›´æ¥newçš„è¯ä¼šå¯¹å †å†…å­˜é€ æˆè¾ƒå¤§è´Ÿæ‹…ï¼Œæ‰€ä»¥æ‰æœ‰å¯¹è±¡å¤ç”¨æœºåˆ¶ã€‚</p><h3 id="idlehandleræ˜¯ä»€ä¹ˆ"><a href="#idlehandleræ˜¯ä»€ä¹ˆ" class="headerlink" title="idlehandleræ˜¯ä»€ä¹ˆ"></a><strong>idlehandleræ˜¯ä»€ä¹ˆ</strong></h3><p>idlehandler å°±æ˜¯åœ¨æ¶ˆæ¯é˜Ÿåˆ—å–ç©ºæˆ–ä¸‹ä¸€ä¸ªæ¶ˆæ¯éœ€è¦ç­‰å¾…æ—¶å³å°†è¿›å…¥ pollOnce ç­‰å¾…ä¹‹å‰å›è°ƒçš„ä¸€ä¸ªæ¥å£ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">interface</span> <span class="title class_">IdleHandler</span> &#123;</span><br><span class="line">    <span class="comment">// è¿”å› false å°±ä¼šåœ¨å›è°ƒä¸€æ¬¡åç§»é™¤</span></span><br><span class="line">    <span class="comment">// è¿”å› true åˆ™ä¼šä¸€ç›´ä¿ç•™</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">queueIdle</span><span class="params">()</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="idlehandlerå¯ä»¥ç”¨æ¥åšå“ªä¸€ç±»ä»»åŠ¡"><a href="#idlehandlerå¯ä»¥ç”¨æ¥åšå“ªä¸€ç±»ä»»åŠ¡" class="headerlink" title="idlehandlerå¯ä»¥ç”¨æ¥åšå“ªä¸€ç±»ä»»åŠ¡"></a><strong>idlehandlerå¯ä»¥ç”¨æ¥åšå“ªä¸€ç±»ä»»åŠ¡</strong></h3><p>æ‰§è¡Œä¼˜å…ˆçº§è¶³å¤Ÿä½çš„ä»»åŠ¡</p><h3 id="å¦‚æœæˆ‘é¢‘ç¹æ·»åŠ idlehandleræ˜¯å¦å‘ç”Ÿanr"><a href="#å¦‚æœæˆ‘é¢‘ç¹æ·»åŠ idlehandleræ˜¯å¦å‘ç”Ÿanr" class="headerlink" title="å¦‚æœæˆ‘é¢‘ç¹æ·»åŠ idlehandleræ˜¯å¦å‘ç”Ÿanr"></a><strong>å¦‚æœæˆ‘é¢‘ç¹æ·»åŠ idlehandleræ˜¯å¦å‘ç”Ÿanr</strong></h3><p>åªè¦ idlehandler ä¸­çš„å¤„ç†æ²¡æœ‰è€—æ—¶é€»è¾‘å°±ä¸ä¼šï¼Œæ¯æ¬¡ç©ºé—²æ‰§è¡Œçš„ idlehandler ä¸ä¼šè¶…è¿‡4ä¸ªã€‚</p><h3 id="looperçš„loopæ˜¯æ­»å¾ªç¯ä¼šé€ æˆanrå˜›ï¼Ÿä¸ºä»€ä¹ˆ"><a href="#looperçš„loopæ˜¯æ­»å¾ªç¯ä¼šé€ æˆanrå˜›ï¼Ÿä¸ºä»€ä¹ˆ" class="headerlink" title="looperçš„loopæ˜¯æ­»å¾ªç¯ä¼šé€ æˆanrå˜›ï¼Ÿä¸ºä»€ä¹ˆ"></a><strong>looperçš„loopæ˜¯æ­»å¾ªç¯ä¼šé€ æˆanrå˜›ï¼Ÿä¸ºä»€ä¹ˆ</strong></h3><p>ä¸ä¼šï¼Œå› ä¸º loop è¿›å»æœ‰æ¶ˆæ¯çš„æ—¶å€™ä¼šå¤„ç†æ¶ˆæ¯ï¼Œæ²¡æœ‰æ¶ˆæ¯çš„æ—¶å€™ä¼šè¿›å…¥ epoll ç­‰å¾…ï¼Œanr çš„åŸå› åœ¨äºæ²¡æœ‰åŠæ—¶å¤„ç†æ¶ˆæ¯ã€‚</p><h3 id="ANR-çš„åŸå› "><a href="#ANR-çš„åŸå› " class="headerlink" title="ANR çš„åŸå› "></a><strong>ANR çš„åŸå› </strong></h3><ul><li><p><strong>ç³»ç»Ÿè¿›ç¨‹(system_server)</strong> è°ƒåº¦ï¼Œè®¾ç½®å®šæ—¶ç›‘æ§ï¼ˆå³åŸ‹ä¸‹ç‚¸å¼¹ï¼‰</p></li><li><p>system_server è¿›ç¨‹å°†ä»»åŠ¡æ´¾å‘åˆ°<strong>åº”ç”¨è¿›ç¨‹</strong>å®Œæˆå¯¹æ¶ˆæ¯çš„å®é™…å¤„ç†(æ‰§è¡Œä»»åŠ¡)</p></li><li><p>æœ€åï¼Œæ‰§è¡Œä»»åŠ¡æ—¶é—´è¿‡é•¿ï¼Œåœ¨å®šæ—¶å™¨è¶…æ—¶å‰ system_server è¿˜<strong>æœªæ”¶åˆ°ä»»åŠ¡å®Œæˆçš„é€šçŸ¥</strong>ï¼Œè§¦å‘ ANRï¼ˆç‚¸å¼¹çˆ†ç‚¸ï¼‰</p></li></ul><p>æ²¡æœ‰åŠæ—¶å¤„ç† system_server æ´¾å‘çš„ä»»åŠ¡ï¼Œsystem_server æ²¡æœ‰æ”¶åˆ°ä»»åŠ¡å®Œæˆçš„é€šçŸ¥ï¼Œå°±è§¦å‘äº† ANRã€‚</p><h3 id="handler-looper-messagequeueæ˜¯æ€ä¹ˆä¸ªå…³ç³»ä¸€å¯¹ä¸€è¿˜æ˜¯ä¸€å¯¹å¤šï¼Œå¤šå¯¹å¤š"><a href="#handler-looper-messagequeueæ˜¯æ€ä¹ˆä¸ªå…³ç³»ä¸€å¯¹ä¸€è¿˜æ˜¯ä¸€å¯¹å¤šï¼Œå¤šå¯¹å¤š" class="headerlink" title="handler looper messagequeueæ˜¯æ€ä¹ˆä¸ªå…³ç³»ä¸€å¯¹ä¸€è¿˜æ˜¯ä¸€å¯¹å¤šï¼Œå¤šå¯¹å¤š"></a><strong>handler looper messagequeueæ˜¯æ€ä¹ˆä¸ªå…³ç³»ä¸€å¯¹ä¸€è¿˜æ˜¯ä¸€å¯¹å¤šï¼Œå¤šå¯¹å¤š</strong></h3><p>Looper è·Ÿ MessageQueue æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ã€‚MessageQueue è·Ÿ Handler æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ã€‚</p><h3 id="looperå’Œthreadæ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»æ˜¯å¦‚ä½•å®ç°çš„"><a href="#looperå’Œthreadæ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»æ˜¯å¦‚ä½•å®ç°çš„" class="headerlink" title="looperå’Œthreadæ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»æ˜¯å¦‚ä½•å®ç°çš„"></a><strong>looperå’Œthreadæ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»æ˜¯å¦‚ä½•å®ç°çš„</strong></h3><p>ä½¿ç”¨ ThreadLocal ä¿å­˜ Looper å®ä¾‹</p><h3 id="threadlocalæ˜¯ä»€ä¹ˆï¼Œæœ‰ç”¨è¿‡å—"><a href="#threadlocalæ˜¯ä»€ä¹ˆï¼Œæœ‰ç”¨è¿‡å—" class="headerlink" title="threadlocalæ˜¯ä»€ä¹ˆï¼Œæœ‰ç”¨è¿‡å—"></a><strong>threadlocalæ˜¯ä»€ä¹ˆï¼Œæœ‰ç”¨è¿‡å—</strong></h3><p>ThreadLocal æœ¬è´¨ä¸Šæ˜¯ä¿å­˜åœ¨ Thread ä¸Šé¢çš„ä¸€å¼  HashMapï¼Œä¸åŒä¹‹å¤„åœ¨ä¸å®ƒçš„é”®ä½¿ç”¨ WeakReference å­˜å‚¨ï¼Œåœ¨ set æ—¶ä¼šæ¸…ç† key &#x3D;&#x3D; null çš„é”®å€¼å¯¹ã€‚ä½†ç”¨å®Œçš„æ—¶å€™æœ€å¥½æ‰‹åŠ¨ removeï¼Œä¸ç„¶è¿˜æ˜¯ä¼šå†…å­˜æ³„æ¼ã€‚ä½¿ç”¨å¼±å¼•ç”¨åªæ˜¯è®© ThreadLocalMap æŒæœ‰çš„ ThreadLocal ä¸ä¼šå†…å­˜æ³„æ¼ï¼ŒThreadLocal å¯¹åº”çš„å€¼è¿˜æ˜¯ä¼šå†…å­˜æ³„æ¼ã€‚</p><h3 id="messagequeueæ˜¯ä»€ä¹ˆæ•°æ®ç»“æ„"><a href="#messagequeueæ˜¯ä»€ä¹ˆæ•°æ®ç»“æ„" class="headerlink" title="messagequeueæ˜¯ä»€ä¹ˆæ•°æ®ç»“æ„"></a><strong>messagequeueæ˜¯ä»€ä¹ˆæ•°æ®ç»“æ„</strong></h3><p>é“¾è¡¨å®ç°çš„ä¼˜å…ˆé˜Ÿåˆ—</p><h3 id="å»¶è¿Ÿæ¶ˆæ¯æ˜¯å¦‚ä½•å®ç°çš„"><a href="#å»¶è¿Ÿæ¶ˆæ¯æ˜¯å¦‚ä½•å®ç°çš„" class="headerlink" title="å»¶è¿Ÿæ¶ˆæ¯æ˜¯å¦‚ä½•å®ç°çš„"></a><strong>å»¶è¿Ÿæ¶ˆæ¯æ˜¯å¦‚ä½•å®ç°çš„</strong></h3><p>æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ä¸€ä¸ªä¼˜å…ˆé˜Ÿåˆ—ï¼Œæ’å…¥æ—¶è¿›è¡Œæ’åºã€‚æ’å…¥æ—¶å¦‚æœæ¶ˆæ¯å¤„äºå¤´éƒ¨ï¼Œä¸”äº‹ä»¶é˜Ÿåˆ—å¤„äºç­‰å¾…çŠ¶æ€å°±å”¤é†’å®ƒï¼ŒLooper æ‹¿äº†å¤´éƒ¨çš„æ¶ˆæ¯å°±ä¼š <code>pollOnce</code> ç­‰å¾…è¿™ä¸ªæ¶ˆæ¯éœ€è¦ç­‰å¾…çš„æ—¶é—´åå†å°†æ¶ˆæ¯å‡ºé˜Ÿä¼ é€’ç»™ Handlerã€‚å¦‚æœæœ‰é˜Ÿåˆ—é¡¶éƒ¨æœ‰åŒæ­¥å±éšœçš„è¯ï¼Œæœ€æ—©çš„å¼‚æ­¥æ¶ˆæ¯å°†ä¼šè¿›è¡Œå”¤é†’å¤„ç†ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;è§£æ&quot;&gt;&lt;a href=&quot;#è§£æ&quot; class=&quot;headerlink&quot; title=&quot;è§£æ&quot;&gt;&lt;/a&gt;&lt;strong&gt;è§£æ&lt;/strong&gt;&lt;/h2&gt;&lt;p&gt;handler æºç ä¹Ÿç®—æ˜¯è€ç”Ÿå¸¸è°ˆäº†ï¼Œä¹‹å‰ä¹Ÿç®€å•ç ”ç©¶è¿‡æºç ã€‚é¦–å…ˆåˆ—å‡ºæ¯”è¾ƒé‡è¦çš„å‡ ä¸ªç±»&lt;/p&gt;
&lt;ul&gt;
&lt;</summary>
      
    
    
    
    
    <category term="android" scheme="http://blog.coldrain.ink/tags/android/"/>
    
    <category term="å…«è‚¡" scheme="http://blog.coldrain.ink/tags/%E5%85%AB%E8%82%A1/"/>
    
  </entry>
  
  <entry>
    <title>æ–°çš„å¼€å§‹</title>
    <link href="http://blog.coldrain.ink/2023/06/27/VKtzd4IhRo6MwPxfJuDcow4gnwb/"/>
    <id>http://blog.coldrain.ink/2023/06/27/VKtzd4IhRo6MwPxfJuDcow4gnwb/</id>
    <published>2023-06-27T16:01:19.000Z</published>
    <updated>2024-01-18T09:11:43.000Z</updated>
    
    <content type="html"><![CDATA[<p>çœ‹äº†ä¸€ä¸‹å‘¨å›´äººçš„åšå®¢ï¼Œè§‰å¾—æˆ‘åŸæ¥çš„åšå®¢å®åœ¨æ˜¯èŠ±é‡Œèƒ¡å“¨ä¸”æ²¡æœ‰è¥å…»ï¼Œäºæ˜¯åˆ æ‰ä»¥å‰çš„æ‰€æœ‰æ–‡ç« ï¼Œé¡ºä¾¿æ¢äº†ä¸ªæ¸…çˆ½çš„ä¸»é¢˜ï¼šbutterflyï¼Œå¹¶ä¸”ç»™åšå®¢æ”¯æŒäº† RSS è®¢é˜…ã€‚</p><p>æ³¡æ³¡æ›¾æ¨èæˆ‘ä½¿ç”¨ä»–çš„æ–¹æ¡ˆ <code>zola + no-style-please</code>ã€‚ä¸è¿‡æˆ‘å®åœ¨æ‡’å¾—æŠ˜è…¾ <code>zola</code>ï¼Œå¹¶ä¸” <code>no-style-please</code> å¯¹æˆ‘æ¥è¯´æœ‰äº›è¿‡äºç®€çº¦äº†ã€‚</p><p>æ€»ä¹‹ä»¥åæˆ‘ä¼šå°½æˆ‘æ‰€èƒ½çš„äº§å‡ºé«˜è´¨é‡åšå®¢ï¼Œè€Œä¸æ˜¯åƒä»¥å‰ä¸€æ ·é¸¡æ¯›è’œçš®çš„å°äº‹ä¹Ÿè¦æ°´ä¸€ç¯‡åšæ–‡ :D</p><blockquote><p>ç®€çº¦å¹¶ä¸æ˜¯ç®€é™‹ï¼Œç®€çº¦çš„ç›®çš„æ˜¯æŠ½å‡ºè®¾è®¡ä¸­æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ã€‚è¿™å’Œç¼–ç¨‹ä¸€æ ·ï¼ŒæŠ½è±¡å‡ºä¸»è¦éƒ¨åˆ†çš„ç¨‹åºæ€»æ˜¯å¾ˆå¥½ç†è§£ä¸”å¾ˆå¥½ç»´æŠ¤çš„ï¼Œè€Œä¸æ˜¯è¿½ç©¶ä»»ä½•ä¸€ä¸ªç»†å°çš„ç»“æ„ï¼Œä¸ºå…¶å¥—ä¸Šå„ç§è®¾è®¡æ¨¡å¼ï¼Œæœ€ç»ˆçš„ç»“æœåªä¼šæ˜¯éš¾ä»¥ç»´æŠ¤ï¼Œå’Œå½“åˆè¿ç”¨å„ç§è®¾è®¡æ¨¡å¼çš„åˆè¡·èƒŒç¦»äº†ã€‚</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;çœ‹äº†ä¸€ä¸‹å‘¨å›´äººçš„åšå®¢ï¼Œè§‰å¾—æˆ‘åŸæ¥çš„åšå®¢å®åœ¨æ˜¯èŠ±é‡Œèƒ¡å“¨ä¸”æ²¡æœ‰è¥å…»ï¼Œäºæ˜¯åˆ æ‰ä»¥å‰çš„æ‰€æœ‰æ–‡ç« ï¼Œé¡ºä¾¿æ¢äº†ä¸ªæ¸…çˆ½çš„ä¸»é¢˜ï¼šbutterflyï¼Œå¹¶ä¸”ç»™åšå®¢æ”¯æŒäº† RSS è®¢é˜…ã€‚&lt;/p&gt;
&lt;p&gt;æ³¡æ³¡æ›¾æ¨èæˆ‘ä½¿ç”¨ä»–çš„æ–¹æ¡ˆ &lt;code&gt;zola + no-style-please&lt;/code&gt;</summary>
      
    
    
    
    
    <category term="é—²èŠ" scheme="http://blog.coldrain.ink/tags/%E9%97%B2%E8%81%8A/"/>
    
  </entry>
  
</feed>
